---
title: "Dunlop growth rates - change in abundance"
author: "Cassandra Wattenburger"
date: "1/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** Investigate how abundance changes during growth.

Main hypothesis: Different soil habitats and/or amendments will cause bacteria to increase in abundance more or less due to ecological factors.

Prediction: Cropped and C-amended soils will see the greatest increases in abundance over the growth period.

1. using the start and end of the estimated growth window

**Import libraries**

```{r}
library(tidyverse)
library(lmerTest)
library(emmeans)

sessionInfo()

rm(list=ls())
```

**Import data**

```{r}
# Normalized abundances
ucosms = readRDS("rdata.files/ucosm.norm.cleaned.rds")

# Estimated growth rates
gr.est = readRDS("rdata.files/gr.final.cleaned.rds")
```

**Reformat**

Isolate start and end data

```{r}
# Isolate ASVs with estimated growth rates
ucosms.gr = semi_join(ucosms, gr.est, by="ASV")

# Remove 0s (what was done to estimate growth rates)
ucosms.gr = filter(ucosms.gr, norm_abund > 0)

# Isolate start and end of growth data for each ASV in each treatment
abundchange = data.frame()
for (s in unique(gr.est$Soil)) {
  for (a in unique(gr.est[gr.est$Soil==s,]$Amendment)) {
    for (r in unique(gr.est[gr.est$Soil==s & gr.est$Amendment==a,]$Replicate)) {
      for (i in unique(gr.est[gr.est$Soil==s & gr.est$Amendment==a & gr.est$Replicate==r,]$ASV)) {
        gr.sub = filter(gr.est, Soil==s & Amendment==a & Replicate==r & ASV==i)
        start = gr.sub$start_day # time point NOT day
        end = gr.sub$end_day # time point NOT day
        ucosms.sub = filter(ucosms.gr, Soil==s & Amendment==a & Replicate==r & ASV==i) %>%
          arrange(Day) # need to order by day so start and end select correct day value
        start.abund = ucosms.sub[ucosms.sub$Day==start,]$norm_abund # abundance at start of growth window
        end.abund = ucosms.sub[ucosms.sub$Day==end,]$norm_abund # abundance at end of growth window
        newrow = data.frame("Soil"=s, "Amendment"=a, "Replicate"=r, "ASV"=i,
                       "start_abund"=start.abund, "end_abund"=end.abund, "k"=gr.sub$k)
        abundchange = rbind(abundchange, newrow)
      }
    }
  }
}

```

Calculate change in abundance

```{r}
# Change in abundance
abundchange = mutate(abundchange, change_abund = end_abund-start_abund)

# Average across replicates to get an average abundance change for each ASV
abundchange.asv = abundchange %>%
  group_by(Soil, Amendment, ASV) %>%
  summarize(change_abund = mean(change_abund),
            k = mean(k))

# Average across ASVs for an estimate of abundance change in whole community
abundchange.trt = abundchange %>%
  group_by(Soil, Amendment, Replicate) %>%
  summarize(change_abund = mean(change_abund))
```

**Visualize change in abundance**

```{r}
# Treatments
# Basically shows overall community trends
abundchange.trt %>%
  ggplot(aes(x=Soil, y=change_abund, color=Amendment)) +
  geom_point() +
  labs(title="Whole community") +
  theme_test()

# Individual ASVs
# Shows differences in individual species
abundchange.asv %>%
  ggplot(aes(x=Soil, y=log(change_abund), color=Amendment)) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  labs(title = "Individual ASVs") +
  theme_test()
```

Appears as though changes in abundance were generally greater in amended and succesional soils. It makes sense that adding C and nutrients to the soil lifted restrictions on growth. For the successional soil, this might be consistent with thought that sieving and storing caused greater mortality and biomass loss in successional soil (based on DNA extraction results) and more C may have been available as a result, compared to cropped soil.

**Statistics**

Two factor ANOVA for whole community change in abundance.

```{r}
# Fit ANOVA to data that has been summarized over ASVs
abundchange.trt.aov = aov(change_abund ~ Soil + Amendment, data = abundchange.trt)
hist(residuals(abundchange.trt.aov))
plot(predict(abundchange.trt.aov), residuals(abundchange.trt.aov))
```

Assumptions aren't violated. Check results.

```{r}
summary(abundchange.trt.aov)
```

Amendment has significant impact on change in abundance during growth.


Linear mixed-effects model for individual ASV data

* Soil and amendment as main effects
* ASV as random effect to allow for variation

```{r}
# Fit model
abundchange.asv.lmer = lmer(log(change_abund) ~ Soil + Amendment + (1|ASV), data=abundchange.asv)

# Check model assumptions
hist(residuals(abundchange.asv.lmer)) # check normality
plot(predict(abundchange.asv.lmer), residuals(abundchange.asv.lmer)) # check variances
```

```{r}
summary(abundchange.asv.lmer)
```

# "Slow" vs "fast" change in abundance

### Correlation between growth rate and change in abundance

Do slow or fast growing taxa differ in how much their abundance changes?

Hypothesis: fast growing taxa increased in abundance more than slow growing taxa.

Visualize correlation:

```{r}
# Correlation
abundchange.asv %>%
  ggplot(aes(x=log(k), y=log(change_abund))) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()

# Correlation by soil and treatment
abundchange.asv %>%
  ggplot(aes(x=log(k), y=log(change_abund))) +
  geom_point() +
  facet_wrap(Soil~Amendment) +
  geom_smooth(method="lm") +
  theme_test()
```

**Statistics**

Pearson correlations between growth rate and change in abundance with multiple test correction.

```{r}
# All data
overall.pcor = cor.test(log(abundchange.asv$k), log(abundchange.asv$change_abund),
                        method="pearson")

# Treatments
grabund.pcor = data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data.sub = filter(abundchange.asv, Soil==s & Amendment==a)
    pcor = cor.test(log(data.sub$k), log(data.sub$change_abund), method="pearson")
    newrow = data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    grabund.pcor = bind_rows(grabund.pcor, newrow)
  }
}

# Multiple test correction
padj = p.adjust(c(grabund.pcor$pvalue, overall.pcor$p.value), method="holm", n=5)

# Make summary table
grabund.pcor = grabund.pcor %>%
  bind_rows(data.frame("Soil"="both", "Amendment"="both", # add overall result
                       "estimate"=overall.pcor$estimate, 
                       "pvalue"=overall.pcor$p.value)) %>%
  bind_cols(padj) %>% # add adjusted p-values
  rename(padj=5)

# Results
grabund.pcor
```

# Relationship between 16S copy number and change in abundance

Hypothesis: 16S rRNA copy number is related to growth in-situ.
Prediction: + correlation because bacteria with more copies have greater potential growth rate and ability to quickly capitalize on resources when they appear.

Import 16S copy number estimate data:

```{r}
# Import paprica data
copynum = readRDS(file="rdata.files/paprica.est.rds")

# Merge with abundance change data
abundchange.copynum.asv = abundchange.asv %>%
  full_join(copynum, by="ASV")
```

Visualize:

```{r}
# all data
abundchange.copynum.asv %>%
  ggplot(aes(x=log(change_abund), y=log(n16S))) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()

# by treatment
abundchange.copynum.asv %>%
  ggplot(aes(x=log(change_abund), y=log(n16S))) +
  geom_point() +
  facet_wrap(Soil~Amendment) +
  geom_smooth(method="lm") +
  theme_test()
```

**Statistics**

Try pearson correlation to evaluate relationship between 16S copy number and growth.

```{r}
# All data
abundchange.copynum.asv.pcor = cor.test(log(abundchange.copynum.asv$n16S),
                                         log(abundchange.copynum.asv$change_abund),
                                         method="pearson")

# Treatments
abundchange.copynum.asv.trt.pcors = data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data.sub = filter(abundchange.copynum.asv, Soil==s & Amendment==a)
    pcor = cor.test(log(data.sub$n16S), log(data.sub$change_abund), method="pearson")
    newrow = data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    abundchange.copynum.asv.trt.pcors = bind_rows(abundchange.copynum.asv.trt.pcors, newrow)
  }
}

# Multiple test correction
padj = p.adjust(c(abundchange.copynum.asv.trt.pcors$pvalue,
                  abundchange.copynum.asv.pcor$p.value), method="holm", n=5)

# Make summary table
abundchange.copynum.asv.trt.pcors = abundchange.copynum.asv.trt.pcors %>%
  bind_rows(data.frame("Soil"="both", "Amendment"="both", # add overall result
                       "estimate"=abundchange.copynum.asv.pcor$estimate, 
                       "pvalue"=abundchange.copynum.asv.pcor$p.value)) %>%
  bind_cols(padj) %>% # add adjusted p-values
  rename(padj=5) # rename fifth column with adjusted pvalues

# Results
abundchange.copynum.asv.trt.pcors
```

Only significant in aggregated data and C3Y.

