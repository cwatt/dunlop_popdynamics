---
title: "Dunlop growth rates - change in abundance"
author: "Cassandra Wattenburger"
date: "1/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** Investigate how abundance changes during growth.

Main hypothesis: Different soil habitats and/or amendments will cause bacteria to increase in abundance more or less due to ecological factors.

Prediction: Cropped and C-amended soils will see the greatest increases in abundance over the growth period.

1. using the start and end of the estimated growth window

**Import libraries**

```{r}
library(tidyverse)
library(lmerTest)
library(emmeans)

sessionInfo()

rm(list=ls())
```

**Import data**

```{r}
# Normalized abundances
ucosms = readRDS("rdata.files/ucosm.norm.cleaned.rds")

# Estimated growth rates
gr.est = readRDS("rdata.files/gr.final.cleaned.rds")
```

**Reformat**

Isolate start and end of growth window data

```{r}
# Isolate ASVs with estimated growth rates
ucosms.gr = semi_join(ucosms, gr.est, by="ASV")

# Remove 0s (what was done to estimate growth rates)
ucosms.gr = filter(ucosms.gr, norm_abund > 0)

# Isolate start and end of growth data for each ASV in each treatment
gr.abund = data.frame()
for (s in unique(gr.est$Soil)) {
  for (a in unique(gr.est[gr.est$Soil==s,]$Amendment)) {
    for (r in unique(gr.est[gr.est$Soil==s & gr.est$Amendment==a,]$Replicate)) {
      for (i in unique(gr.est[gr.est$Soil==s & gr.est$Amendment==a & gr.est$Replicate==r,]$ASV)) {
        gr.sub = filter(gr.est, Soil==s & Amendment==a & Replicate==r & ASV==i)
        start = gr.sub$start_day # time point NOT day
        end = gr.sub$end_day # time point NOT day
        ucosms.sub = filter(ucosms.gr, Soil==s & Amendment==a & Replicate==r & ASV==i) %>%
          arrange(Day) # need to order by day so start and end select correct day value
        start.abund = ucosms.sub[ucosms.sub$Day==start,]$norm_abund # abundance at start of growth window
        end.abund = ucosms.sub[ucosms.sub$Day==end,]$norm_abund # abundance at end of growth window
        newrow = data.frame("Soil"=s, "Amendment"=a, "Replicate"=r, "ASV"=i,
                       "start_abund"=start.abund, "end_abund"=end.abund, "k"=gr.sub$k)
        gr.abund = rbind(gr.abund, newrow)
      }
    }
  }
}

```

Calculate change in abundance

```{r}
# Change in abundance
gr.abund = mutate(gr.abund, change_abund = end_abund-start_abund)

# Average across replicates to get an average abundance change for each ASV
gr.abund.asv = gr.abund %>%
  group_by(Soil, Amendment, ASV) %>%
  summarize(start_abund = mean(start_abund), end_abund = mean(end_abund), change_abund = mean(change_abund),
            k = mean(k))

# Average across ASVs for an estimate of abundance change in whole community
gr.abund.trt = gr.abund %>%
  group_by(Soil, Amendment, Replicate) %>%
  summarize(change_abund = mean(change_abund))
```

**Visualize change in abundance**

```{r}
# Treatments
# Basically shows overall community trends
gr.abund.trt %>%
  ggplot(aes(x=Soil, y=change_abund, color=Amendment)) +
  geom_point() +
  labs(title="Whole community") +
  theme_test()

# Individual ASVs
# Shows differences in individual species
gr.abund.asv %>%
  ggplot(aes(x=Soil, y=log(change_abund), color=Amendment)) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  labs(title = "Individual ASVs") +
  theme_test()
```

Appears as though changes in abundance were generally greater in amended and succesional soils. It makes sense that adding C and nutrients to the soil lifted restrictions on growth. For the successional soil, this might be consistent with thought that sieving and storing caused greater mortality and biomass loss in successional soil (based on DNA extraction results) and more C may have been available as a result, compared to cropped soil.

**Statistics**

Two factor ANOVA for whole community change in abundance.

```{r}
# Fit ANOVA to data that has been summarized over ASVs
gr.abund.trt.aov = aov(change_abund ~ Soil + Amendment, data = gr.abund.trt)
hist(residuals(gr.abund.trt.aov))
plot(predict(gr.abund.trt.aov), residuals(gr.abund.trt.aov))
```

Assumptions aren't violated. Check results.

```{r}
summary(gr.abund.trt.aov)
```

Amendment has significant impact on change in abundance during growth.


Linear mixed-effects model for individual ASV data

* Soil and amendment as main effects
* ASV as random effect to allow for variation

```{r}
# Fit model
gr.abund.asv.lmer = lmer(log(change_abund) ~ Soil + Amendment + (1|ASV), data=gr.abund.asv)

# Check model assumptions
hist(residuals(gr.abund.asv.lmer)) # check normality
plot(predict(gr.abund.asv.lmer), residuals(gr.abund.asv.lmer)) # check variances
```

Normality looks fine, residuals plot is odd but verticle spread looks consistent throughout.

```{r}
# look at results
summary(gr.abund.asv.lmer)
```

# Correlation between growth rate and change in abundance

Do slow or fast growing taxa differ in how much their abundance changes?

Hypothesis: fast growing taxa increased in abundance more than slow growing taxa.

**Visualize**

```{r}
# Correlation
gr.abund.asv %>%
  ggplot(aes(x=log(k), y=log(change_abund))) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()

# Correlation by soil and treatment
gr.abund.asv %>%
  ggplot(aes(x=log(k), y=log(change_abund))) +
  geom_point() +
  facet_wrap(Soil~Amendment) +
  geom_smooth(method="lm") +
  theme_test()
```

**Statistics**

Pearson correlations between growth rate and change in abundance with multiple test correction.

```{r}
# All data
overall.pcor = cor.test(log(gr.abund.asv$k), log(gr.abund.asv$change_abund),
                        method="pearson")

# Treatments
grabund.pcor = data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data.sub = filter(gr.abund.asv, Soil==s & Amendment==a)
    pcor = cor.test(log(data.sub$k), log(data.sub$change_abund), method="pearson")
    newrow = data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    grabund.pcor = bind_rows(grabund.pcor, newrow)
  }
}

# Multiple test correction
padj = p.adjust(c(grabund.pcor$pvalue, overall.pcor$p.value), method="holm", n=5)

# Make summary table
grabund.pcor = grabund.pcor %>%
  bind_rows(data.frame("Soil"="both", "Amendment"="both", # add overall result
                       "estimate"=overall.pcor$estimate, 
                       "pvalue"=overall.pcor$p.value)) %>%
  bind_cols(padj) %>% # add adjusted p-values
  rename(padj=5)

# Results
grabund.pcor
```

# Starting abundance vs change in abundance

Do lower abundance taxa have the most to gain, or are high abundance taxa poised to take advantage of resources?

**Visualize**

```{r}
gr.abund.asv %>% 
  ggplot(aes(x=log(start_abund), y=log(change_abund))) + # log transform change abundance because taxa that start high will naturally change in abundance more due to exponential growth
  geom_point() + 
  geom_smooth(method="lm") +
  theme_test()

gr.abund.asv %>% 
  ggplot(aes(x=log(start_abund), y=log(change_abund))) + # log transform change abundance because taxa that start high will naturally change in abundance more due to exponential growth
  geom_point() + 
  facet_wrap(Soil~Amendment) +
  geom_smooth(method="lm") +
  theme_test()

```

Does this need to be normalized in some way to account for exponential growth, or did log transform take care of that?

Seems like taxa with high biomass to start may have more successful during growth. Possibly because they were more likely to access C? Relationship does look slightly stronger in C-amended treatment.

**Statistics**

Pearson correlation

```{r}
# All data
startchange.all.pcor = cor.test(log(gr.abund.asv$start_abund), log(gr.abund.asv$change_abund),
                        method="pearson")

# Treatments
startchange.pcor = data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data.sub = filter(gr.abund.asv, Soil==s & Amendment==a)
    pcor = cor.test(log(data.sub$start_abund), log(data.sub$change_abund), method="pearson")
    newrow = data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    startchange.pcor = bind_rows(startchange.pcor, newrow)
  }
}

# Multiple test correction
padj = p.adjust(c(startchange.pcor$pvalue, startchange.all.pcor$p.value), method="holm", n=5)

# Make summary table
startchange.pcor = startchange.pcor %>%
  bind_rows(data.frame("Soil"="both", "Amendment"="both", # add overall result
                       "estimate"=startchange.all.pcor$estimate, 
                       "pvalue"=startchange.all.pcor$p.value)) %>%
  bind_cols(padj) %>% # add adjusted p-values
  rename(padj=5) %>%
  select(everything(), -pvalue) # get rid of unadjusted pvalues

# Results
startchange.pcor
```



# Relationship between 16S copy number and change in abundance

Hypothesis: 16S rRNA copy number is related to growth in-situ.
Prediction: + correlation because bacteria with more copies have greater potential growth rate and ability to quickly capitalize on resources when they appear.

Import 16S copy number estimate data:

```{r}
# Import paprica data
copynum = readRDS(file="rdata.files/paprica.est.rds")

# Merge with abundance change data
gr.abund.copynum.asv = gr.abund.asv %>%
  full_join(copynum, by="ASV")
```

Visualize:

```{r}
# all data
gr.abund.copynum.asv %>%
  ggplot(aes(x=log(change_abund), y=log(n16S))) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_test()

# by treatment
gr.abund.copynum.asv %>%
  ggplot(aes(x=log(change_abund), y=log(n16S))) +
  geom_point() +
  facet_wrap(Soil~Amendment) +
  geom_smooth(method="lm") +
  theme_test()
```

**Statistics**

Try pearson correlation to evaluate relationship between 16S copy number and growth.

```{r}
# All data
gr.abund.copynum.asv.pcor = cor.test(log(gr.abund.copynum.asv$n16S),
                                         log(gr.abund.copynum.asv$change_abund),
                                         method="pearson")

# Treatments
gr.abund.copynum.asv.trt.pcors = data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data.sub = filter(gr.abund.copynum.asv, Soil==s & Amendment==a)
    pcor = cor.test(log(data.sub$n16S), log(data.sub$change_abund), method="pearson")
    newrow = data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    gr.abund.copynum.asv.trt.pcors = bind_rows(gr.abund.copynum.asv.trt.pcors, newrow)
  }
}

# Multiple test correction
padj = p.adjust(c(gr.abund.copynum.asv.trt.pcors$pvalue,
                  gr.abund.copynum.asv.pcor$p.value), method="holm", n=5)

# Make summary table
gr.abund.copynum.asv.trt.pcors = gr.abund.copynum.asv.trt.pcors %>%
  bind_rows(data.frame("Soil"="both", "Amendment"="both", # add overall result
                       "estimate"=gr.abund.copynum.asv.pcor$estimate, 
                       "pvalue"=gr.abund.copynum.asv.pcor$p.value)) %>%
  bind_cols(padj) %>% # add adjusted p-values
  rename(padj=5) # rename fifth column with adjusted pvalues

# Results
gr.abund.copynum.asv.trt.pcors
```

Only significant in aggregated data and C3Y. No meaningful conclusions here.

# Start abundance vs growth rate

Are slow growers more rare?

```{r}
gr.abund.asv %>% 
  ggplot(aes(y=log(start_abund), x=log(k))) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(Soil~Amendment) +
  theme_test()
```

No clear relationship.
