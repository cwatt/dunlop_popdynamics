---
title: "Dunlop growth rates - biomass and growth rates"
author: "Cassandra Wattenburger"
date: "12/19/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** Explore relationship between biomass and growth rates

Main hypothesis: From Sam's full cyc work. High biomass microbial communities are less responsive to C inputs/avialability (up to a point)
because the C is accessed by more cells and distiributed more evenly among community. In low biomass microbial communities, less cells will have more access to the available C. This will result in moderate growth by many taxa in the high biomass soil but rapid growth by few taxa in the low biomass soil.

Here, we are considering the successional and cropped soils as proxies for high and low biomass communities respectively to see if we can find evidence for this hypothesis.

# Import libraries

```{r}
library(tidyverse)

rm(list=ls())

sessionInfo()
```

# Assess biomass between soils

Using DNA extraction yield as a proxy for microbial biomass. First check if there is evidence for a difference in DNA yield between the cropped and successional soils.

### Import data

```{r}
# Field and ucosm community data
ucosm = readRDS("rdata.files/ucosm.norm.cleaned.rds")
field = readRDS("rdata.files/field.norm.cleaned.rds")

# DNA data
dna = read_csv("growthrate_dnaext.csv") %>%
  mutate(SampleID = as.character(SampleID))

# Combine
ucosm.field.dna = bind_rows(field, ucosm) %>% # combine ucosm and field samples
  inner_join(dna, by = c("Sample"="SampleID")) %>% # add dna data
  rename(dna_conc = Conc., dna_kit = Box) %>% # rename columns
  mutate(Type = if_else(Sample %in% 1:80, "Field", "Microcosm")) # Name based on experiment type

# Estimated growth rates
gr.est = readRDS("rdata.files/gr.final.cleaned.rds")
```

### Visualize

```{r}
# Field
ucosm.field.dna %>%
  distinct(Sample, Soil, Amendment, Block, Type, dna_conc) %>%
  filter(Type=="Field") %>%
  ggplot(aes(x=Soil, y=dna_conc)) +
  geom_point() +
  labs(title="Field") +
  facet_wrap(~Block) +
  theme_test()

# Microcosm
ucosm.field.dna %>%
  distinct(Sample, Soil, Amendment, Day, Type, dna_conc) %>%
  filter(Type=="Microcosm", Amendment=="N", Day==0) %>% # unamended, day 0 samples only
  ggplot(aes(x=Soil, y=dna_conc)) +
  geom_point() +
  labs(title="Ucosms") +
  theme_test()
```

Microcosm soil DNA yeild decreased compared to field samples, particularly in successional soil. Disturbance of sieving and storing must have been very destructive. Unfortunately, this will mask any correlations between growth rates and DNA conc.

### Statistics

**Field soil**

* Only testing block 1 because that's where the soil for the microcosms originated
* Simple linear model

```{r}
# Isolate data
field.block1 = ucosm.field.dna %>%
  filter(Type=="Field", Block==1) %>%
  distinct(Sample, Soil, dna_conc)

# Fit linear model
field.block1.lm = lm(dna_conc ~ Soil, field.block1)
hist(resid(field.block1.lm))
plot(predict(field.block1.lm), resid(field.block1.lm))
```
Assumption of normality violated, try log transform.

```{r}
# Fit linear model
field.block1.lm2 = lm(log(dna_conc) ~ Soil, field.block1)
hist(resid(field.block1.lm2))
plot(predict(field.block1.lm2), resid(field.block1.lm2))
```

Improved, but hetereskedasticity is worse. I think it's ok for interpretation though, since this is a simple model with no interactions etc.

```{r}
summary(field.block1.lm2)
```

**Microcosm soil**

* Testing only day 0, unamended samples. Represent starting commnunity in subset of samples that showed bimodal growth rate distributions
* simple linear model

```{r}
# Isolate data
ucosm.n0 = ucosm.field.dna %>%
  filter(Type=="Microcosm", Day==0, Amendment=="N") %>%
  distinct(Sample, Soil, dna_conc)

# Fit linear model
ucosm.n0.lm = lm(dna_conc ~ Soil, ucosm.n0)
hist(resid(ucosm.n0.lm))
plot(predict(ucosm.n0.lm), resid(ucosm.n0.lm))
```

Same problem. Try log transform.

```{r}
# Fit linear model, log transform
ucosm.n0.lm2 = lm(log(dna_conc) ~ Soil, ucosm.n0)
hist(resid(ucosm.n0.lm2))
plot(predict(ucosm.n0.lm2), resid(ucosm.n0.lm2))
```

```{r}
summary(ucosm.n0.lm2)
```

The higher-level of processing and incubation period before the start of the experiment may have equalized the microbial community biomass compared to in-field conditions. Despite this, I'm still going to look into possible correlations with growth rates because legacy effects from the field may still be present. Sam also used highly-processed soil in his microcosms.


# Growth rates and biomass

Going to test two metrics to test hypothesis.

1. Proportion of growing taxa compared to total taxa present in community (prediction: high biomass = greater proportion of community grows because resources distributed more evenly)
2. Ratio of slow and fast growers (prediction: high biomass = higher ratio of slow to fast)

**Proportion of taxa that grew compared to total taxa**

```{r}
# Total number of taxa
ucosm.biomass = ucosm %>% 
  filter(norm_abund > 0, Amendment=="N", Day==0) %>% # filter non-present ASVs, only keep unammended samples
  group_by(Sample, Soil, Replicate) %>%
  summarize(total_asv = length(ASV))

# Total number of taxa that grew
gr.totals = gr.est %>% group_by(Soil, Replicate) %>% summarize(growing_asv = length(ASV))

# Combine dataframes and calculate metric
ucosm.propgrow = inner_join(ucosm.biomass, gr.totals) %>%
  mutate(prop_grow = growing_asv/total_asv)

# Add DNA data
ucosm.propgrow = inner_join(ucosm.propgrow, dna, by=c("Sample"="SampleID")) %>%
  rename(dna_conc = Conc., dna_kit = Box)
```

Visualize

```{r}
# By soil
ucosm.propgrow %>%
  ggplot(aes(x=Soil, y=prop_grow)) +
  geom_point() +
  theme_test()

# By DNA conc
ucosm.propgrow %>%
  ggplot(aes(x=dna_conc, y=prop_grow, color=Soil)) +
  geom_point() +
  theme_test()
```

Statistics

* Simple linear regression
* proportion of community that grew vs. dna yield

```{r}
propgrow.lm = lm(prop_grow ~ dna_conc, ucosm.propgrow)
hist(resid(propgrow.lm))
plot(resid(propgrow.lm), predict(propgrow.lm))

summary(propgrow.lm)
```


**Proportion of slow taxa**

```{r}
# Import group labels
gr.groups = readRDS("rdata.files/gr.groups.rds")

# Label taxa in microcosm soils
gr.label.crop = gr.est %>%
  filter(Soil=="C3", Amendment=="N") %>%
  inner_join(gr.groups, by=c("Soil", "ASV"))

gr.label.succ = gr.est %>%
  filter(Soil=="S17", Amendment=="N") %>%
  inner_join(gr.groups, by=c("Soil", "ASV"))

gr.label = bind_rows(gr.label.crop, gr.label.succ)
  
gr.label.slow = gr.label %>%
  group_by(Soil, Replicate, group) %>% 
  summarize(group_count = length(ASV)) %>%
  pivot_wider(names_from=group, values_from=group_count) %>%
  mutate(prop_slow = slow/(slow+fast))

# Add sample metadata
meta = select(ucosm, Sample, Day, Amendment, Soil, Replicate) %>%
  filter(Day==0, Amendment=="N") %>%
  distinct()

gr.label.slow = inner_join(gr.label.slow, meta, by=c("Soil", "Replicate"))

# Add DNA conc. data
gr.label.slow = inner_join(gr.label.slow, dna, by=c("Sample"="SampleID")) %>%
  rename(dna_conc = Conc., dna_kit = Box)
```

Visualize

```{r}
# By soil
gr.label.slow %>%
  ggplot(aes(x=Soil, y=prop_slow, color=Soil)) +
  geom_point() +
  theme_test()

# vs. DNA conc.
gr.label.slow %>%
  ggplot(aes(x=dna_conc, y=prop_slow)) +
  geom_point(aes(color=Soil)) +
  geom_smooth(method="lm") +
  theme_test()

```

Statistics

* Simple linear regression
* proportion of slow taxa in cropped vs successional soil

```{r}
slow.lm = lm(prop_slow ~ Soil, gr.label.slow)
hist(resid(slow.lm)
```

Not normal, try log transform.

```{r}
slow.lm2 = lm(log(prop_slow) ~ Soil, gr.label.slow)
hist(resid(slow.lm2))
```

No, use Kruskal Wallis test (does not assume normality)

```{r}
slow.kruskal = kruskal.test(prop_slow ~ Soil, data=gr.label.slow)
slow.kruskal
```
