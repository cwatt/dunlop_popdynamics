---
title: "Dunlop growth rates - phylogenetic conservation"
author: "Cassandra Wattenburger"
date: "02/16/21"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** Investigate phylogenetic conservation of in-situ growth rates.

Hypothesis: in-situ growth rates are conserved.

# Import libraries

```{r}
library(tidyverse)
library(phyloseq)
library(vegan)
library(ape)

sessionInfo()
```

# Import data

* growth rate estimates
* normalized abundances

```{r}
ucosm <- readRDS("rdata.files/gr_ucosm.norm.clean.rds")

growth <- readRDS("rdata.files/gr_gr.paprica.clean.rds")

# Merge
ucosm.growth <- inner_join(ucosm, growth)

# Average ASV by replicate
ucosm.growth.asv = ucosm.growth %>%
  group_by(Soil, Amendment, ASV, Domain, Phylum, Class, Order, Family, Genus) %>%
  summarise(k = mean(k))
```


# Growth rates by phyla

```{r}
# Overall
ucosm.growth.asv %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "Overall", y = "", x = "log mean specific growth rate") +
  theme_test()

# By treatment
ucosm.growth.asv %>%
  filter(Soil=="C3", Amendment=="N") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(shape=1, alpha = 0.2) +
  labs(title = "Cropped, water", y = "", x = "log mean specific growth rate") +
  theme_test()

ucosm.growth.asv %>%
  filter(Soil=="C3", Amendment=="Y") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "Cropped, C-amended", y = "", x = "log mean specific growth rate") +
  theme_test()

ucosm.growth.asv %>%
  filter(Soil=="S17", Amendment=="N") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "Successional, water", y = "", x = "log mean specific growth rate") +
  theme_test()

ucosm.growth.asv %>%
  filter(Soil=="C3", Amendment=="Y") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "Successional, C-amended", y = "", x = "log mean specific growth rate") +
  theme_test()

# By soil
ucosm.growth.asv %>%
  filter(Soil=="C3") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "Cropped, water and C-amended", y = "", x = "log mean specific growth rate") +
  theme_test()

ucosm.growth.asv %>%
  filter(Soil=="S17") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "Successional, water and C-amended", y = "", x = "log mean specific growth rate") +
  theme_test()

# By amendment
ucosm.growth.asv %>%
  filter(Amendment=="N") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "Water, both soils", y = "", x = "log mean specific growth rate") +
  theme_test()

ucosm.growth.asv %>%
  filter(Amendment=="Y") %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  labs(title = "C-amended, both soils", y = "", x = "log mean specific growth rate") +
  theme_test()
```


**Zoom in**

* Proteobacteria
* Actinobacteria
* Verrucomicrobia
* Acidobacteria
* Planctomycetes

```{r}
# NOTE: figure out how to add number of observations label to these graphs

# Visualize
for (p in c("Proteobacteria", "Actinobacteria", "Verrucomicrobia", "Acidobacteria", "Planctomycetes")) {
  # Class level
  print(ucosm.growth.asv %>%
    filter(Phylum==p) %>%
    ggplot(aes(x=log(k), y=fct_reorder(Class, -k))) +
    geom_boxplot() +
    geom_jitter(alpha = 0.2) +
    labs(title = paste(p, "classes, overall"), y = "", x = "log mean specific growth rate") +
    theme_test())
    
  # Genus level
  print(ucosm.growth.asv %>%
    filter(Phylum==p) %>%
    ggplot(aes(x=log(k), y=fct_reorder(Genus, -k))) +
    geom_boxplot() +
    geom_jitter(alpha = 0.2) +
    labs(title = paste(p, "genera, overall"), y = "", x = "log mean specific growth rate") +
    theme_test())
}
```

Overall, growth rates of taxonomic groups tend to have a wide spread, particularly if they have more observations. This seems to indicate that there is not much taxonomic conservation in growth rates. Let's test this statistically.


# Mantel correlogram

Import phyloseq object of normalized microcosm data

```{r}
# Old messy script, couldn't be bothered to clean up

# Import normalized data
physeq <- readRDS("rdata.files/gr_physeq.ucosm.norm.rds")
```

Calculate phylogenetic distances and correlate

```{r, eval=FALSE}
# Run mantel correlogs within each soil and amendment treatment separately
for (s in c("S17","C3")) { 
  for (a in c("Y","N")) { 
    # Subset data by treatment
    sub.physeq <- subset_samples(physeq, Soil==s & Amendment==a)
    
    # Remove OTUs not found in at least 3 samples
    OTU.table <- otu_table(sub.physeq)
    OTU.table[OTU.table > 0] = 1
    OTU.freq <- rowSums(OTU.table)
    OTU.freq <- OTU.freq[OTU.freq > 2]
    sub.physeq <- prune_taxa(names(OTU.freq), sub.physeq)
    
    # Remove OTUs without growth estimates
    sub.gr <- ucosm.growth.asv[ucosm.growth.asv$Soil==s & ucosm.growth.asv$Amendment==a,]
    gr.OTU <- as.character(unique(sub.gr$ASV)) 
    sub.physeq <- prune_taxa(gr.OTU, sub.physeq) 
    
    # Calculate phylogenetic distances
    sub.tree <- phy_tree(sub.physeq)
    phylo.dist <- cophenetic(sub.tree) 
    sample_OTUs <- sub.tree$tip.label 
    sam.phylo.dist <- phylo.dist[sample_OTUs, sample_OTUs]
    sam.phylo.dist[upper.tri(sam.phylo.dist, diag=TRUE)] = NA
    
    # Generate distance matrices from estimated growth rates
    sub.gr <- sub.gr[sub.gr$ASV %in% sample_OTUs,] # Only include estimates from taxa in tree
    sub.gr <- sub.gr[,c(3,10)]
    sub.gr <- column_to_rownames(sub.gr, var="ASV")
    #sub.gr <- sub.gr[,1, drop=FALSE] # BREAKS
    gr.dist <- as.matrix(dist(sub.gr), labels=TRUE)
    
    # Correlog
    gr.phylo.crlg <- mantel.correlog(sam.phylo.dist, gr.dist)
    
    # Save results
    filename = paste0("rdata.files/", s, a, ".mantelcorrelog.rds")
    saveRDS(gr.phylo.crlg, file=filename)
  }
}
```

```{r}
# Read in mantel correlogs
S17y.growth.crlg <- data.frame(readRDS("rdata.files/S17Y.mantelcorrelog.rds")$mantel.res) %>%
  mutate(Soil="Successional", Amend="Y")

S17n.growth.crlg <- data.frame(readRDS("rdata.files/S17N.mantelcorrelog.rds")$mantel.res) %>% 
  mutate(Soil="Successional", Amend="N")

C3y.growth.crlg <- data.frame(readRDS("rdata.files/C3Y.mantelcorrelog.rds")$mantel.res) %>% 
  mutate(Soil="Cropped", Amend="Y")

C3n.growth.crlg <- data.frame(readRDS("rdata.files/C3N.mantelcorrelog.rds")$mantel.res) %>% 
  mutate(Soil="Cropped", Amend="N")

# Merge into one data frame
growth.crlg <- bind_rows(S17y.growth.crlg, S17n.growth.crlg, C3y.growth.crlg, C3n.growth.crlg) %>%
  mutate(sig=ifelse(Pr.corrected. <= 0.05, "significant", "non-significant")) %>% filter(!(is.na(Pr.corrected.))) # denote significance
```

Visualize:

```{r, results="show"}
# plot correlograms
ggplot(data=growth.crlg, aes(x=class.index, y=Mantel.cor)) +
  geom_point(data=growth.crlg[growth.crlg$sig=="significant",], color="black", size=2, shape=16) +
  geom_point(data=growth.crlg[growth.crlg$sig=="non-significant",], color="black", size=2, shape=1) +
  geom_line() +
  geom_hline(yintercept=0, linetype=2) +
  labs(x="Phylogenetic distance", y="Mantel correlation (specific growth rate)") +
  facet_grid(Soil~Amend) +
  theme_test()
```

Filled circles are significant, unfilled circles are not significant.


# Figures

```{r}
# Overall
p1 = ucosm.growth.asv %>%
  ggplot(aes(x=log(k), y=fct_reorder(Phylum, -k))) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2, shape=1) +
  labs(y = "", x = expression("Specific growth rate (ln day"^{-1}*")")) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        title = element_text(size=10),
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 8))
p1
```

```{r, eval=FALSE}
ggsave(p1, file="figures/suppfig_phylagr.pdf", device=pdf, width=140, height=140, units="mm")
```
