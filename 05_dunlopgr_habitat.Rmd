---
title: "Dunlop growth rates - habitat"
author: "Cassandra Wattenburger"
date: "11/10/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** Investigate the effects of soil habitat on in-situ growth rates

# Import libraries

```{r}
library(tidyverse)
library(cowplot)
library(data.table)
library(phyloseq)
library(lmerTest)

sessionInfo()

rm(list=ls())
```

Import estimated growth rates:

```{r}
gr.est = readRDS("rdata.files/gr.final.cleaned.rds")
```

# Growth properties

Average across ASVs to get community level data. ASVs within same community are not independent of one-another, which would screw up statistics. Unfortunately, singleton ASV estimates prevents me frrom using a mixed-linear effects model with ASV as a random effect, which would be ideal, so we must average instead.

```{r}
gr.est.avg = gr.est %>%
  group_by(Soil, Amendment, Replicate) %>% # average across ASVs
  summarize(avg_start = mean(Start),
            avg_end = mean(End),
            avg_length = mean(Length),
            avg_k = mean(k))
```


### Start of growth

```{r}
gr.est.avg %>%
  ggplot(aes(x=Soil, y=avg_start, color=Amendment)) +
  geom_boxplot() +
  labs(title="Start of growth", y="Day") +
  theme_test()
```

**Statistics**

Try ANOVA.

```{r}
strt.aov = aov(avg_start ~ Soil + Amendment + Soil:Amendment, data=gr.est.avg)
hist(resid(strt.aov))
```

Model residuals are not normal. Try log transform.

```{r}
strt.aov2 = aov(log(avg_start) ~ Soil + Amendment + Soil:Amendment, data=gr.est.avg)
hist(resid(strt.aov2))
plot(predict(strt.aov2), resid(strt.aov2))
summary(strt.aov2)
```

Start of growth is affected by soil and depends on the amendment.

Post hoc: 

Only interested in certain contrasts, ie doesn't make sense to compare cropped water to successional C-amended.

Using Welch's t-tests (fewer assumptions) with Benjamini-Hochberg correction.

```{r}
# Contrasts
start.wtest1 = t.test(log(avg_start) ~ Amendment, data=gr.est.avg[gr.est.avg$Soil=="C3",], var.equal = FALSE)
start.wtest2 = t.test(log(avg_start) ~ Amendment, data=gr.est.avg[gr.est.avg$Soil=="S17",], var.equal = FALSE)
start.wtest3 = t.test(log(avg_start) ~ Soil, data=gr.est.avg[gr.est.avg$Amendment=="Y",], var.equal = FALSE)
start.wtest4 = t.test(log(avg_start) ~ Soil, data=gr.est.avg[gr.est.avg$Amendment=="N",], var.equal = FALSE)

# Adjust p-values
start.pvals = c(start.wtest1$p.value, start.wtest2$p.value, start.wtest3$p.value, start.wtest4$p.value)
start.adjpvals = p.adjust(start.pvals, method="BH", n=length(start.pvals))

# Results
start.results = data.frame(contrast = c("Cropped, C vs W", "Successional, C vs W", "C-amended, cropped vs succ.", "Water, cropped vs succ."), pvals = start.adjpvals)
start.results
```

### End of growth window

```{r}
gr.est.avg %>%
  ggplot(aes(x=Soil, y=avg_end, color=Amendment)) +
  geom_boxplot() +
  labs(title="End of growth", y="Day") +
  theme_test()
```

**Statistics**

```{r}
end.aov = aov(avg_end ~ Soil + Amendment + Soil:Amendment, data=gr.est.avg)
hist(resid(end.aov))
plot(predict(end.aov), resid(end.aov))
summary(end.aov)
```

End of growth is affected by soil and depends on the amendment.

Post hoc: 

Only interested in certain contrasts, ie doesn't make sense to compare cropped water to successional C-amended.

Using Welch's t-tests (fewer assumptions) with Benjamini-Hochberg correction.

```{r}
# Contrasts
end.wtest1 = t.test(avg_end ~ Amendment, data=gr.est.avg[gr.est.avg$Soil=="C3",], var.equal = FALSE)
end.wtest2 = t.test(avg_end ~ Amendment, data=gr.est.avg[gr.est.avg$Soil=="S17",], var.equal = FALSE)
end.wtest3 = t.test(avg_end ~ Soil, data=gr.est.avg[gr.est.avg$Amendment=="Y",], var.equal = FALSE)
end.wtest4 = t.test(avg_end ~ Soil, data=gr.est.avg[gr.est.avg$Amendment=="N",], var.equal = FALSE)

# Adjust p-values
end.pvals = c(end.wtest1$p.value, end.wtest2$p.value, end.wtest3$p.value, end.wtest4$p.value)
end.adjpvals = p.adjust(end.pvals, method="BH", n=length(end.pvals))

# Results
end.results = data.frame(contrast = c("Cropped, C vs W", "Successional, C vs W", "C-amended, cropped vs succ.", "Water, cropped vs succ."), pvals = end.adjpvals)
end.results
```

No significance.


### Length of growth window

```{r}
gr.est.avg %>%
  ggplot(aes(x=Soil, y=avg_length, color=Amendment)) +
  geom_boxplot() +
  labs(title="Length of growth", y="Day") +
  theme_test()
```

**Statistics**

```{r}
length.lm = lm(avg_length ~ Soil + Amendment + Soil:Amendment, data=gr.est.avg)
hist(resid(length.lm))
```

Linear model fit is not normal. Try log transform.

```{r}
length.lm2 = lm(log(avg_length) ~ Soil + Amendment + Soil:Amendment, data=gr.est.avg)
hist(resid(length.lm2))
plot(predict(length.lm2), resid(length.lm2))
summary(length.lm2)
```

Length of growth in not significant.

### Specific growth rates

```{r}
gr.est.avg %>%
  ggplot(aes(x=Soil, y=log(avg_k), color=Amendment)) +
  geom_boxplot() +
  labs(title="Specific growth rate", y="Specific growth rate, ln (per Day)") +
  theme_test()
```


**Statistics**

```{r}
k.aov = lm(avg_k ~ Soil + Amendment + Soil:Amendment, data=gr.est.avg)
hist(resid(k.aov))
```

Try log transform.

```{r}
k.aov2 = aov(log(avg_k) ~ Soil + Amendment + Soil:Amendment, data=gr.est.avg)
hist(resid(k.aov2))
plot(predict(k.aov2), resid(k.aov2))
summary(k.aov2)
```

No significance found.

### Create table of results:

```{r}
gr.est %>%
  group_by(Soil, Amendment) %>%
  summarize(avg_k = mean(k), sd_k = sd(k), avg_start = mean(Start), sd_start = sd(Start), avg_end = mean(End), sd_end = sd(End), avg_len = mean(Length), sd_len = sd(Length))
```


### End of growth


Generation time:

```{r}
gr.est %>% summarize(min_g=min(g), max_g=max(g), mean_g=mean(g))
```


# Overlapping estimates between treatments

```{r}
# Isolate treatment ASV names
gr.C3.asv = gr.est %>% filter(Soil=="C3") %>% distinct(ASV)
gr.S17.asv = gr.est %>% filter(Soil=="S17") %>% distinct(ASV)
gr.C3y.asv = gr.est %>% filter(Soil=="C3", Amendment=="Y") %>% distinct(ASV)
gr.C3n.asv = gr.est %>% filter(Soil=="C3", Amendment=="N") %>% distinct(ASV)
gr.S17y.asv = gr.est %>% filter(Soil=="S17", Amendment=="Y") %>% distinct(ASV)
gr.S17n.asv = gr.est %>% filter(Soil=="S17", Amendment=="N") %>% distinct(ASV)

# Overlap
inner_join(gr.C3.asv, gr.S17.asv) %>% nrow()
inner_join(gr.C3y.asv, gr.C3n.asv) %>% nrow()
inner_join(gr.S17y.asv, gr.S17n.asv) %>% nrow()
```

# Growth rate distributions

Average across replicates: makes for cleaner presentation.

```{r}
gr.estavg = gr.est %>% 
  group_by(Soil, Amendment, ASV, Domain, Phylum, Class, Order, Family, Genus) %>% 
  summarize(avgk = mean(k), avgStart = mean(Start), avgEnd = mean(End), avgLength = mean(Length))
```

Kernel density graphs

See: https://www.statsmodels.org/dev/examples/notebooks/generated/kernel_density.html

```{r, results="show"}
gr.estavg %>% 
  filter(Amendment=="N") %>%
  ggplot(aes(x=log(avgk), color=Soil, fill=Soil)) +
  geom_density(alpha=0.5) +
  labs(title="Only water", x="log specific growth rate", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  scale_color_manual(labels = c("Cropped", "Successional"), values=c("#F8766D","#00BFC4")) +
  scale_fill_manual(labels = c("Cropped", "Successional"), values=c("#F8766D","#00BFC4")) +
  scale_y_continuous(limits=c(0,1)) +
  scale_x_continuous(limits=c(-5,0))

gr.estavg %>% 
  filter(Amendment=="Y") %>%
  ggplot(aes(x=log(avgk), color=Soil, fill=Soil)) +
  geom_density(alpha=0.5) +
  labs(title="C-amended", x="log specific growth rate", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  scale_color_manual(labels = c("Cropped", "Successional"), values=c("#F8766D","#00BFC4")) +
  scale_fill_manual(labels = c("Cropped", "Successional"), values=c("#F8766D","#00BFC4")) +
  scale_y_continuous(limits=c(0,1)) +
  scale_x_continuous(limits=c(-5,0))

gr.estavg %>% 
  filter(Soil=="C3") %>%
  ggplot(aes(x=log(avgk), color=Amendment, fill=Amendment)) +
  geom_density(alpha=0.5) +
  labs(title="Cropped", x="log specific growth rate", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  scale_color_manual(labels = c("C-added", "Water"), values=c("#E78E43", "#423EC5")) +
  scale_fill_manual(labels = c("C-added", "Water"), values=c("#E78E43", "#423EC5")) +
  scale_y_continuous(limits=c(0,1)) +
  scale_x_continuous(limits=c(-5,0))

gr.estavg %>% 
  filter(Soil=="S17") %>%
  ggplot(aes(x=log(avgk), color=Amendment, fill=Amendment)) +
  geom_density(alpha=0.5) +
  labs(title="Successional", x="log specific growth rate", y="Kernel Density") +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  scale_color_manual(labels = c("C-added", "Water"), values=c("#E78E43", "#423EC5")) +
  scale_fill_manual(labels = c("C-added", "Water"), values=c("#E78E43", "#423EC5")) +
  scale_y_continuous(limits=c(0,1)) +
  scale_x_continuous(limits=c(-5,0))
```


# Growth rate distribution binning

Hypothesis: growth rate distributions will differ by soil and by amendment.

In order to conduct tests on the distirbution of the data, I need to bin it discretely. The bins will need to be equal width and have the same start and end points across treatments so that they are comparable, and the number of bins must be chosen to simplify the data without losing too much of the "shape" of the distribution (see smoothed histograms above for reference).

Ranging from 5 to 10 bins.

Overall:

```{r}
for (i in 5:10) {
  print(gr.estavg %>%
    ggplot(aes(x=log(avgk))) +
    geom_histogram(bins=i, color="black", fill="gray") +
    theme_test() +
    labs(title=paste("Overall,", i, "bins", sep=" ")))
}
```

Treatments:

```{r}
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    for (i in 5:10) {
      print(gr.estavg %>%
        filter(Soil==s, Amendment==a) %>%
        ggplot(aes(x=log(avgk))) +
        geom_histogram(bins=i, color="black", fill="gray") +
        theme_test() +
        labs(title=paste(s, a, i, "bins")))
    }
  }
}
```

It looks like 5 bins is too few, 6 or 7 seem to more adequately capture the distributions. I'll choose 7 bins.

There need to be the same number and width of bins in each dataset.

Caculate min, max, and range of specific growth rate values in whole dataset:

```{r, , results="show"}
print(paste("Min:", min(log(gr.estavg$avgk))))
print(paste("Max:", max(log(gr.estavg$avgk))))
print(paste("Range:", max(log(gr.estavg$avgk))-min(log(gr.estavg$avgk))))
```

Calculate bin width based on range:

```{r, results="show"}
width = (max(log(gr.estavg$avgk))-min(log(gr.estavg$avgk)))/7
print(paste("Bin width:", width))

kmin=min(log(gr.estavg$avgk))
print(paste("Bin 1 boundaries: less than", kmin+width))
print(paste("Bin 2 boundaries:", kmin+width, "to",  kmin+width*2))
print(paste("Bin 3 boundaries:", kmin+width*2, "to",  kmin+width*3))
print(paste("Bin 4 boundaries:", kmin+width*3, "to",  kmin+width*4))
print(paste("Bin 5 boundaries:", kmin+width*4, "to",  kmin+width*5))
print(paste("Bin 6 boundaries:", kmin+width*5, "to",  kmin+width*6))
print(paste("Bin 7 boundaries:", kmin+width*6, "and greater"))
```

```{r}
# Bin data based on boundaries chosen and log k
gr.est.bins = gr.est %>% mutate(bin = ifelse(log(k) < kmin+width, 1, ifelse(log(k) < kmin+width*2, 2, ifelse(log(k) < kmin+width*3, 3, ifelse(log(k) < kmin+width*4, 4, ifelse(log(k) < kmin+width*5, 5, ifelse(log(k) < kmin+width*6, 6, 7)))))))

# Calculate bin information (proportion, frequency)
gr.bins = data.frame()
for (s in as.character(unique(gr.est.bins$Soil))) { 
  for (a in as.character(unique(gr.est.bins$Amendment))) {
    for (r in as.character(unique(gr.est.bins$Replicate))) {
      total = nrow(gr.est.bins[gr.est.bins$Soil==s & gr.est.bins$Amendment==a & gr.est.bins$Replicate==r,])
      for (b in as.character(unique(gr.est.bins$bin))) {
        bin = gr.est.bins[gr.est.bins$Soil==s & gr.est.bins$Amendment==a & gr.est.bins$Replicate==r & gr.est.bins$bin==b,]
        binfreq = nrow(bin)
        binratio = binfreq/total
        thisrow = data.frame(s, a, r, b, binfreq, binratio)
        gr.bins = rbind(gr.bins, thisrow)   
      }
    }
  }
}
colnames(gr.bins) = c("Soil","Amendment","Replicate","bin","frequency","proportion")
gr.bins$bin = factor(gr.bins$bin, levels=c(1,2,3,4,5,6,7))
```

Plot bins:

```{r, results="show"}
ggplot(gr.bins) +
  geom_boxplot(aes(x=bin, y=proportion, color=Soil)) +
  facet_wrap(~Amendment) +
  theme_test() +
  labs(x="Slow to fast", y="Proportion of total taxa")

ggplot(gr.bins) +
  geom_boxplot(aes(x=bin, y=frequency, color=Soil)) +
  facet_wrap(~Amendment) +
  theme_test() +
  labs(x="Slow to fast", y="Frequency")

ggplot(gr.bins) +
  geom_boxplot(aes(x=bin, y=proportion, color=Amendment)) +
  facet_wrap(~Soil) +
  scale_color_manual(values=c("#E78E43", "#423EC5")) +
  theme_test() +
  labs(x="Slow to fast", y="Proportion of total taxa")

ggplot(gr.bins) +
  geom_boxplot(aes(x=bin, y=frequency, color=Amendment)) +
  facet_wrap(~Soil) +
  scale_color_manual(values=c("#E78E43", "#423EC5")) +
  theme_test() +
  labs(x="Slow to fast", y="Frequency")
```

**Statistics**

First, I want to know if the distribution of growth rates differs by habitat or amendment. I'll use a contingency table and Fisher's exact test.

See: http://www.biostathandbook.com/fishers.html

```{r}
# Average replicates and round (Frischer's needs integers, not continuous numbers)
gr.bins.avg = gr.bins %>% group_by(Soil, Amendment, bin) %>% summarize(avgfreq = mean(frequency)) %>% mutate(avgfreq.rnd = round(avgfreq))

# Make contingency tables
conting.y = dcast(gr.bins.avg[gr.bins.avg$Amendment=="Y",], Soil~bin, value.var="avgfreq.rnd")
conting.y = conting.y[,-1] %>% as.matrix()

conting.n = dcast(gr.bins.avg[gr.bins.avg$Amendment=="N",], Soil~bin, value.var="avgfreq.rnd")
conting.n = conting.n[,-1] %>% as.matrix()

conting.C3 = dcast(gr.bins.avg[gr.bins.avg$Soil=="C3",], Amendment~bin, value.var="avgfreq.rnd")
conting.C3 = conting.C3[,-1] %>% as.matrix()

conting.S17 = dcast(gr.bins.avg[gr.bins.avg$Soil=="S17",], Amendment~bin, value.var="avgfreq.rnd")
conting.S17 = conting.S17[,-1] %>% as.matrix()

# Run Fisher's exact tests
set.seed(1)
fish.testy = fisher.test(conting.y, simulate.p.value = TRUE)
fish.testn = fisher.test(conting.n, simulate.p.value = TRUE)
fish.testC3 = fisher.test(conting.C3, simulate.p.value = TRUE)
fish.testS17 = fisher.test(conting.S17, simulate.p.value = TRUE)

# Multiple test correction
fish.pvals = c(fish.testn$p.value, fish.testy$p.value, fish.testC3$p.value, fish.testS17$p.value)
fish.padj = p.adjust(fish.pvals, method="holm", n=length(fish.pvals))
print(paste("Unamended cropped vs Succ., adj. p-value:", fish.padj[1]))
print(paste("Amended cropped vs Succ., adj. p-value:", fish.padj[2]))
print(paste("Cropped amended vs unamended, adj. p-value:", fish.padj[3]))
print(paste("Succ. amended vs unamended, adj. p-value:", fish.padj[4]))
```


# Growth rate shift up/down

Among ASVs that were estimated in both cropped and successional soil treatments, do they reliably shift up or down in growth rate?

Hypotheses: 

1. ASVs found in water and C-amended treatments will grow faster in the C-amended treatment in both soils because of higher resource availability.

2. ASVs found in both cropped and successional soils overall will grow faster in the cropped soil because of greater disturbances in the cropped soil.

```{r}
# Isolate treatment data
gr.C3.avgk = gr.est %>% 
  filter(Soil=="C3") %>% 
  group_by(Soil, ASV) %>% 
  summarize(C3.avgk=mean(k))

gr.S17.avgk = gr.est %>%
  filter(Soil=="S17") %>% 
  group_by(Soil, ASV) %>% 
  summarize(S17.avgk=mean(k))

gr.C3y.avgk = gr.est %>% 
  filter(Soil=="C3", Amendment=="Y") %>% 
  group_by(Soil, Amendment, ASV) %>% 
  summarize(C3y.avgk=mean(k))

gr.C3n.avgk = gr.est %>% 
  filter(Soil=="C3", Amendment=="N") %>% 
  group_by(Soil, Amendment, ASV) %>% 
  summarize(C3n.avgk=mean(k))

gr.S17y.avgk = gr.est %>% 
  filter(Soil=="S17", Amendment=="Y") %>% 
  group_by(Soil, Amendment, ASV) %>% 
  summarize(S17y.avgk=mean(k))

gr.S17n.avgk = gr.est %>% 
  filter(Soil=="S17", Amendment=="N") %>% 
  group_by(Soil, Amendment, ASV) %>% 
  summarize(S17n.avgk=mean(k))
```

Visualize:

```{r}
# Overall cropped vs succesional
inner_join(gr.C3.avgk, gr.S17.avgk, by="ASV") %>%
  ggplot(aes(x=C3.avgk, y=S17.avgk)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Cropped, log specific growth rate", y="Successional, log specific growth rate") +
  theme_test()

# Cropped C-amended vs water
inner_join(gr.C3y.avgk, gr.C3n.avgk, by="ASV") %>% 
  ggplot(aes(x=C3y.avgk, y=C3n.avgk)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Cropped C-amended, log specific growth rate", y="Cropped water-amended, log specific growth rate") +
  theme_test()

# Succesional C-amended vs water
inner_join(gr.S17y.avgk, gr.S17n.avgk, by="ASV") %>% 
  ggplot(aes(x=S17y.avgk, y=S17n.avgk)) +
  geom_point() +
  geom_smooth(method="lm") +
  labs(x="Successional C-amended, log specific growth rate", y="Successional water-amended, log specific growth rate") +
  theme_test()
```

Doesn't look promising.

**Statistcs**

Try simple linear regression first:

```{r}
# Test overall cropped vs successional using linear regression
gr.C3S17.avgk = inner_join(gr.C3.avgk, gr.S17.avgk, by="ASV")
gr.C3S17.avgk.lm = lm(C3.avgk ~ S17.avgk, data=gr.C3S17.avgk)

# Evaluate assumptions of linear regression
hist(gr.C3S17.avgk.lm$residuals) # evaluate assumption of normality
plot(predict(gr.C3S17.avgk.lm), resid(gr.C3S17.avgk.lm)) # evaluate assumption of homoskedasticity

# P value
summary(gr.C3S17.avgk.lm)$coefficients[2,4]
```

```{r}
# Cropped C-amended vs water
gr.C3yn.avgk = inner_join(gr.C3y.avgk, gr.C3n.avgk, by="ASV")
gr.C3yn.avgk.lm = lm(C3y.avgk ~ C3n.avgk, data=gr.C3yn.avgk)

# Evaluate assumptions of linear regression
hist(gr.C3yn.avgk.lm$residuals) # evaluate assumption of normality
plot(predict(gr.C3yn.avgk.lm), resid(gr.C3yn.avgk.lm)) # evaluate assumption of homoskedasticity

# P value
summary(gr.C3yn.avgk.lm)$coefficients[2,4]
```

```{r}
# Successional C-amended vs water
gr.S17yn.avgk = inner_join(gr.S17y.avgk, gr.S17n.avgk, by="ASV")
gr.S17yn.avgk.lm = lm(S17y.avgk ~ S17n.avgk, data=gr.S17yn.avgk)

# Evaluate assumptions of linear regression
hist(gr.S17yn.avgk.lm$residuals) # evaluate assumption of normality
plot(predict(gr.S17yn.avgk.lm), resid(gr.S17yn.avgk.lm)) # evaluate assumption of homoskedasticity

# P value
summary(gr.S17yn.avgk.lm)$coefficients[2,4]
```

Assumptions look fine, but the successional overlap data is just sparse. Anyways, nothing is significant.


# Explore bimodal distributions - slow and fast groups?

The growth rate distribution graphs show distinct bimodal distributions in the water treatment. This seems to indicate differing populations, which I want to explore further.

Split data into "fast" and "slow" groups based on the bimodal distributions.

**Split by the bimodal distributions in unamended soils:**

Choose thresholds for each soil:

```{r, results="show"}
gr.estavg %>% 
  filter(Soil=="C3") %>%
  ggplot(aes(x=log(avgk), color=Amendment, fill=Amendment)) +
  geom_density(alpha=0.5) +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  scale_color_manual(values=c("#E78E43", "#423EC5")) +
  scale_fill_manual(values=c("#E78E43", "#423EC5")) +
  labs(title="Cropped", x="ln speciifc growth rate", y="Density") +
  scale_y_continuous(limits=c(0,1)) +
  scale_x_continuous(limits=c(-5,0)) +
  geom_vline(xintercept=-2.4, linetype=2)

gr.estavg %>% 
  filter(Soil=="S17") %>%
  ggplot(aes(x=log(avgk), color=Amendment, fill=Amendment)) +
  geom_density(alpha=0.5) +
  theme_test() +
  theme(#legend.position="none",
        title=element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  scale_color_manual(values=c("#E78E43", "#423EC5")) +
  scale_fill_manual(values=c("#E78E43", "#423EC5")) +
  labs(title="Successional", x="ln speciifc growth rate", y="Density") +
  scale_y_continuous(limits=c(0,1)) +
  scale_x_continuous(limits=c(-5,0)) +
  geom_vline(xintercept=-1.9, linetype=2)
```

Label ASVs based on avg growth rate threshold:

```{r}
# Water only
gr.estavg.group = gr.estavg %>% 
  filter(Amendment=="N") %>% 
  mutate(group = ifelse(Soil=="C3" & log(avgk) < -2.4, "slow", ifelse(Soil=="S17" & log(avgk) < -1.9, "slow", "fast")))

gr.estavg.group = gr.estavg.group[,c(1,3:ncol(gr.estavg.group))]
```

```{r, eval=FALSE}
# save 
saveRDS(gr.estavg.group, file="rdata.files/gr.groups.rds")
```

### Abundances of groups in field communities

Do these taxa exist in the in-field community data? If so, what are they're abundances? I.e. did the soil shape the growth dynamics we observed in the microcosms?

Hypothesis: abundances of slow and fast taxa within field communities differ between cropped and successional soils.

Import field data:

```{r}
# Import data
field = readRDS("rdata.files/field.norm.cleaned.rds")

# Add group labels
field.group = field %>% 
  inner_join(gr.estavg.group, var=c("Soil", "ASV", "Domain", "Phylum", "Class", "Order", "Family", "Genus",)) %>%
  filter(!norm_abund==0) %>% # remove 0 values, ie ASV not present
  mutate(group = parse_factor(group, levels=c("slow", "fast"))) # more intuitive order for groups
```

#### Individual ASV normalized abundances in each group:

```{r}
# Visualize
field.group %>% 
  ggplot(aes(x=group, y=log(norm_abund), color=as.factor(Block))) +
  geom_boxplot() +
  geom_jitter(alpha=0.2) +
  facet_wrap(~Soil) +
  labs(title="Individual ASV abundances", x="", y="natural log internal-standard normalized abundance", color="Block") +
  theme_test()
```

#### Total, aggregated abundances in each group:

```{r}
# Sum abundances in each group
field.group.sum = field.group %>% 
  group_by(Soil, Block, Replicate, group) %>%
  summarize(total_abund = sum(norm_abund))

# Visualize
field.group.sum %>% 
  ggplot(aes(x=group, y=log(total_abund), color=as.factor(Block))) +
  geom_boxplot() +
  geom_jitter(alpha=0.2) +
  facet_wrap(~Soil) +
  labs(title="Total, aggregated abundance", x="", y="natural log internal-standard normalized abundance", color="Block") +
  theme_test()

field.group.sum %>% 
  ggplot(aes(x=group, y=log(total_abund))) +
  geom_boxplot() +
  geom_jitter(alpha=0.2) +
  facet_wrap(~Soil) +
  labs(title="Total, aggregated abundance", x="", y="natural log internal-standard normalized abundance", color="Block") +
  theme_test()
```

Strong block effect in cropped soil.


# Figures

### Distribution of growth rates

```{r}
p1 = gr.estavg %>%
  mutate(Soil = recode_factor(Soil, S17="Successional", C3="Cropped"),
         Amendment = recode_factor(Amendment, N="Water", Y="C-added")) %>%
  ggplot(aes(x=log(avgk), fill=Soil)) +
  geom_density(alpha=0.5) +
  facet_wrap(~Amendment, ncol=1) +
  scale_fill_manual(values=c(NA, "gray")) +
  labs(y="Kernel density", x="Specific growth rate") +
  theme_test() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        legend.position = c(.25,.93),
        legend.text = element_text(size=8),
        legend.key.width=unit(0.5, "cm"),
        legend.key.height=unit(0.5, "cm"),
        legend.title = element_blank(),
        legend.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = unit(c(1, 0, 0, 0), "mm"), size=10),
        axis.title.y = element_text(margin = unit(c(0, 1.5, 0, 0), "mm"), size=10),
        axis.text = element_text(size = 8))
p1

p2 = gr.bins %>%
  mutate(Soil = recode_factor(Soil, S17="Successional", C3="Cropped"),
         Amendment = recode_factor(Amendment, N="Water", Y="C-added")) %>%
  ggplot(aes(x=bin, y=frequency, fill=Soil)) +
  geom_boxplot(alpha=0.5) +
  facet_wrap(~Amendment, ncol=1) +
  scale_fill_manual(values=c(NA, "gray")) +
  labs(x="Bin number", y="Number of ASVs") +
  theme_test() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        legend.position = "none",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = unit(c(1, 0, 0, 0), "mm"), size=10),
        axis.title.y = element_text(margin = unit(c(0, 1.5, 0, 0), "mm"), size=10),
        axis.text = element_text(size = 8))
p2

habitatdist.plot = plot_grid(p1, NULL, p2, nrow=1, align="h", rel_widths=c(1,0.04,1), labels=c("a", NA, "b"), label_size=10)
habitatdist.plot
```

```{r, eval=FALSE}
ggsave(plot=habitatdist.plot, file="figures/fig_habitatdist.pdf", device=pdf, width=140, height=90, units="mm")
```

### Shift in growth rate

```{r}
p3 = inner_join(gr.C3y.avgk, gr.C3n.avgk, by="ASV") %>% 
  ggplot(aes(x=log(C3y.avgk), y=log(C3n.avgk))) +
  geom_point(shape=1) +
  #geom_smooth(method="lm", color="black", linetype=2) +
  labs(x="Cropped, C-amended", y="Cropped, water") +
  scale_x_continuous(limits=c(-3,0)) +
  scale_y_continuous(limits=c(-3,0)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        legend.position = "none",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = unit(c(1, 0, 0, 0), "mm"), size=10),
        axis.title.y = element_text(margin = unit(c(0, 1.5, 0, 0), "mm"), size=10),
        axis.text = element_text(size = 8))
p3

p4 = inner_join(gr.S17y.avgk, gr.S17n.avgk, by="ASV") %>% 
  ggplot(aes(x=log(S17y.avgk), y=log(S17n.avgk))) +
  geom_point(shape=1) +
  #geom_smooth(method="lm", color="black", linetype=2) +
  labs(x="Successional, C-amended", y="Succesional, water") +
  scale_x_continuous(limits=c(-3,0)) +
  scale_y_continuous(limits=c(-3,0)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        legend.position = "none",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = unit(c(1, 0, 0, 0), "mm"), size=10),
        axis.title.y = element_text(margin = unit(c(0, 1.5, 0, 0), "mm"), size=10),
        axis.text = element_text(size = 8))
p4

p5 = inner_join(gr.C3y.avgk, gr.S17y.avgk, by="ASV") %>% 
  ggplot(aes(x=log(C3y.avgk), y=log(S17y.avgk))) +
  geom_point(shape=1) +
  #geom_smooth(method="lm", color="black", linetype=2) +
  labs(x="Cropped, C-amended", y="Succesional, C-amended") +
  scale_x_continuous(limits=c(-3,0)) +
  scale_y_continuous(limits=c(-3,0)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        legend.position = "none",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = unit(c(1, 0, 0, 0), "mm"), size=10),
        axis.title.y = element_text(margin = unit(c(0, 1.5, 0, 0), "mm"), size=10),
        axis.text = element_text(size = 8))
p5

p6 = inner_join(gr.C3n.avgk, gr.S17n.avgk, by="ASV") %>% 
  ggplot(aes(x=log(C3n.avgk), y=log(S17n.avgk))) +
  geom_point(shape=1) +
  #geom_smooth(method="lm", color="black", linetype=2) +
  labs(x="Cropped, water", y="Succesional, water") +
  scale_x_continuous(limits=c(-3,0)) +
  scale_y_continuous(limits=c(-3,0)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        legend.position = "none",
        axis.line = element_line(colour = "black"),
        axis.title.x = element_text(margin = unit(c(1, 0, 0, 0), "mm"), size=10),
        axis.title.y = element_text(margin = unit(c(0, 1.5, 0, 0), "mm"), size=10),
        axis.text = element_text(size = 8))
p6

shift.plot = plot_grid(p3, p4, p5, p6)
shift.plot

```

```{r, eval=FALSE}
ggsave(shift.plot, file="figures/suppfig_shiftgr.pdf", device=pdf, width=140, height=140, units="mm")
```

### Start and end of growth

Note sure if will include.

```{r}
p7 = gr.est.avg %>%
  mutate(Soil = recode_factor(Soil, C3="Cropped", S17="Successional"),
         Amendment = recode_factor(Amendment, Y="C-amended", N="Water")) %>%
  ggplot(aes(x=Soil, y=avg_start)) +
  geom_boxplot(aes(fill=Amendment)) +
  scale_fill_manual(values=c(NA, "gray")) +
  scale_y_continuous(limits=c(0,4)) +
  labs(title="Start of growth", y="Day") +
  theme(legend.title = element_blank(),
        legend.key = element_blank(),
        legend.position = c(0.15, 0.8),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        title = element_text(size = 10),
        axis.title.x = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 8))
p7

p8 = gr.est.avg %>%
  mutate(Soil = recode_factor(Soil, C3="Cropped", S17="Successional"),
         Amendment = recode_factor(Amendment, Y="C-amended", N="Water")) %>%
  ggplot(aes(x=Soil, y=avg_end)) +
  geom_boxplot(aes(fill=Amendment)) +
  scale_fill_manual(values=c(NA, "gray")) +
  scale_y_continuous(limits=c(0,10)) +
  labs(title="End of growth", y="Day") +
  theme(legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        strip.background = element_blank(),
        title = element_text(size = 10),
        axis.title.x = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size = 8))
p8

startend.plots = plot_grid(p7, p8, nrow=2, labels=c("a", "b"), label_size=10)
startend.plots
```

```{r, eval=FALSE}
ggsave(startend.plots, file="figures/fig_startend.pdf", device=pdf, width=140, height=90, units="mm")
```

