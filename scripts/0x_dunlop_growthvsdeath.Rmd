---
title: "Untitled"
author: "Cassandra Wattenburger"
date: "12/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
```

```{r}
rm(list=ls())

library("tidyverse")

sessionInfo()
```

# Import data

```{r}
# Growth and death estimates
growth <- readRDS("../rdata.files/gr_gr.paprica.clean.rds") %>% 
  rename(growth_start_day=start_day, growth_end_day=end_day,
         growth_start_abund=start_abund, growth_end_abund=end_abund) %>% 
  mutate(Label = paste0(Soil, Amendment, Replicate, ASV),
         growth_change_abund = growth_end_abund - growth_start_abund,
         growth_length = growth_end_day - growth_start_day)

death <- readRDS("../rdata.files/gr_death_estimates.rds") %>% 
  select(everything(), -c(start_pt, end_pt, Domain:Genus)) %>% 
  rename(death_start_day=start_day, death_end_day=end_day, death_length = length_days,
         death_start_abund=start_abund, death_end_abund=end_abund, death_change_abund = change_abund)

# Normalized abundances
norm <- readRDS("../rdata.files/gr_ucosm.norm.clean.rds") %>% 
  mutate(Label = paste0(Soil, Amendment, Replicate, ASV)) %>% 
  select(Label, Soil, Amendment, Replicate, ASV, Day, Domain:Genus, norm_abund) %>% 
  filter(norm_abund > 0)

# Taxa with estimated growth and then death
growth_death <- inner_join(growth, death) %>% 
  select(Label, Soil, Amendment, Replicate, Domain:Genus, ASV,
         k, g, growth_start_day, growth_end_day, growth_start_abund, growth_end_abund, growth_change_abund, growth_length,
         death_rate, half_time, death_start_day, death_end_day, death_start_abund, death_end_abund, death_change_abund, death_length, decay,
         edge_num:n16S)
```

# Descriptive stats

### How many death estimates?

Total:

```{r}
nrow(growth_death)
```

Logarithmic:

```{r}
growth_death_log <- filter(growth_death, decay=="logarithmic")
nrow(growth_death_log)
```

Linear:

```{r}
growth_death_lin <- filter(growth_death, decay=="linear")
nrow(growth_death_lin)
```

### How many ASVs with estimated death?

Logarithmic:

```{r}
length(as.character(unique(growth_death_log$ASV)))
```

Linear:

```{r}
length(as.character(unique(growth_death_lin$ASV)))
```

### Number of ASVs per treatment

Logarithmic:

```{r}
death_asvs_log <- growth_death_log %>%
  group_by(Soil, Amendment) %>% 
  summarize(num_est = length(unique(ASV))) %>%
  ungroup()
  
death_asvs_log
```

### Overall descriptive stats

Start, end, and length of death:

```{r}
death_overall <- growth_death %>%
  group_by() %>% 
  summarize(death_start_day_min = min(death_start_day),
            death_start_day_max = max(death_start_day),
            death_start_day_mean = mean(death_start_day),
            death_start_day_sd = sd(death_start_day),
            death_end_day_min = min(death_end_day),
            death_end_day_max = max(death_end_day),
            death_end_day_mean = mean(death_end_day),
            death_end_day_sd = sd(death_end_day)) %>%
  ungroup()
  
death_overall
```

Logarithmic:

```{r}
death_days_log <- growth_death_log %>%
  group_by() %>% 
  summarize(death_start_day_min = min(death_start_day),
            death_start_day_max = max(death_start_day),
            death_start_day_mean = mean(death_start_day),
            death_start_day_sd = sd(death_start_day),
            death_end_day_min = min(death_end_day),
            death_end_day_max = max(death_end_day),
            death_end_day_mean = mean(death_end_day),
            death_end_day_sd = sd(death_end_day)) %>%
  ungroup()

death_days_log
```

Linear:

```{r}
death_days_lin <- growth_death_lin %>%
  group_by() %>% 
  summarize(death_start_day_min = min(death_start_day),
            death_start_day_max = max(death_start_day),
            death_start_day_mean = mean(death_start_day),
            death_start_day_sd = sd(death_start_day),
            death_end_day_min = min(death_end_day),
            death_end_day_max = max(death_end_day),
            death_end_day_mean = mean(death_end_day),
            death_end_day_sd = sd(death_end_day)) %>%
  ungroup()

death_days_lin
```

Halving times (logarithmic only)

```{r}
death_g_log <- growth_death_log %>% 
  group_by() %>% 
  summarize(half_time_min = min(half_time),
            half_time_max = max(half_time),
            half_time_mean = mean(half_time),
            half_time_sd = sd(half_time)) %>% 
  ungroup()

death_g_log
```

### Phyla represented

Logarithmic:

```{r}
# Number of phyla
length(unique(as.character(growth_death_log$Phylum)))

# Which phyla
death_phyla_log <- growth_death_log %>% 
  group_by(Phylum) %>% 
  summarize(num_est = n()) %>%
  ungroup() %>% 
  arrange(desc(num_est))
  
death_phyla_log
```

Linear:

```{r}
# Number of phyla
length(unique(as.character(growth_death_lin$Phylum)))

# Which phyla
death_phyla_lin <- growth_death_lin %>% 
  group_by(Phylum) %>% 
  summarize(num_est = n()) %>%
  ungroup() %>% 
  arrange(desc(num_est))
  
death_phyla_lin
```

# Aggregate parameters

Overview of soil treatment affects on measured community overall.

### Proportion of taxa that grew then died vs just grew

```{r}
count_growth <- growth %>% 
  group_by(Soil, Amendment, Replicate) %>% 
  summarize(growth_count = n()) %>% 
  ungroup()

count_death <- death %>% 
  group_by(Soil, Amendment, Replicate) %>% 
  summarize(death_count = n()) %>% 
  ungroup()

# Proportion
prop_death <- inner_join(count_growth, count_death) %>% 
  mutate(prop =death_count/growth_count)

# Graph
prop_death %>% 
  ggplot(aes(x=Soil, y=prop, color=Amendment)) +
  geom_point() +
  theme_test()
```

Highly variable.

```{r}
# Aggregate parameters (logarithmic only)
growth_death_agg_log <- growth_death_log %>% 
  group_by(Soil, Amendment, Replicate) %>% 
    summarize(k = mean(k), g = mean(g),
            growth_start_day = mean(growth_start_day), growth_end_day = mean(growth_end_day), 
            growth_length = mean(growth_length),
            growth_start_abund_corr = mean(growth_start_abund/n16S, na.rm = TRUE), # 16S copy num correction
            growth_change_abund_corr = mean(growth_change_abund/n16S, na.rm = TRUE), # 16S copy num correction
            death_rate = mean(death_rate),
            death_start_day = mean(death_start_day), death_end_day = mean(death_end_day), 
            death_length = mean(death_length),
            death_start_abund_corr = mean(death_start_abund/n16S, na.rm = TRUE), # 16S copy num correction
            death_change_abund_corr = mean(death_change_abund/n16S, na.rm = TRUE)) %>% # 16S copy num correction
  ungroup() 
```

### Death rate (logarithmic only)

```{r}
growth_death_agg_log %>%
  ggplot(aes(x=Soil, y=death_rate, color=Amendment)) +
  geom_point() +
  theme_test()
```

Highly variable, not seeing a trend.

### Death change abundance (logarithmic only)

```{r}
growth_death_agg_log %>% 
  ggplot(aes(x=Soil, y=abs(death_change_abund_corr), color=Amendment)) +
  geom_point() +
  theme_test()
```

Seems like trend of greater changes in abundance due to death in amended soils?

**Statistics**

Linear model:

```{r}
chabund_agg_log_lm <- lm(abs(death_change_abund_corr) ~ Soil + Amendment + Soil*Amendment, data=growth_death_agg_log)
hist(resid(chabund_agg_log_lm))
plot(predict(chabund_agg_log_lm), resid(chabund_agg_log_lm))
```

I don't like the unequal variance here, even with a log transform. I'll use a Welch's t-test to test amendment.

Welch's t-test:

* Non-transformed data

```{r}
# Cropped
chabund_agg_log_welch <- t.test(abs(death_change_abund_corr) ~ Amendment, data=growth_death_agg_log, var.equal=FALSE)
chabund_agg_log_welch
```

Significant.

# ASV level

Average each ASV across replicates to get a parameter estimate for each taxa in each treatment. This allows a more nuanced investigation of how soil treatments interact with growth responses of individual ASVs/populations rather than the community as a whole.

```{r}
# Average growth estimates for each ASV
growth_asv <- growth %>%
  group_by(ASV, Soil, Amendment) %>% 
  summarize(k = mean(k), g = mean(g),
            growth_start_day = mean(growth_start_day), growth_end_day = mean(growth_end_day), 
            growth_length = mean(growth_length),
            growth_start_abund_corr = mean(growth_start_abund/n16S, na.rm=TRUE),
            growth_change_abund_corr = mean(growth_change_abund/n16S, na.rm=TRUE),
            n16S = mean(n16S, na.rm=TRUE)) %>% 
  ungroup()

# Average death estimates for each ASV
# Logarithmic only
death_asv_log <- death %>% 
  group_by(ASV, Soil, Amendment) %>% 
  summarize(death_rate = mean(death_rate),
            death_start_day = mean(death_start_day), death_end_day = mean(death_end_day), 
            death_length = mean(death_length),
            death_start_abund = mean(death_start_abund), death_end_abund = mean(death_end_abund), 
            death_change_abund = mean(death_change_abund)) %>% 
  ungroup()

# Both growth and death
growth_death_asv <- growth_death %>%
  group_by(ASV, Soil, Amendment, decay) %>% 
  summarize(k = mean(k), g = mean(g),
            growth_start_day = mean(growth_start_day), growth_end_day = mean(growth_end_day), 
            growth_length = mean(growth_length),
            growth_start_abund_corr = mean(growth_start_abund/n16S, na.rm=TRUE),
            growth_change_abund_corr = mean(growth_change_abund/n16S, na.rm=TRUE),
            death_rate = mean(death_rate),
            death_start_day = mean(death_start_day), death_end_day = mean(death_end_day), 
            death_length = mean(death_length),
            death_start_abund_corr = mean(death_start_abund/n16S, na.rm=TRUE),
            death_change_abund_corr = mean(death_change_abund/n16S, na.rm=TRUE),
            n16S = mean(n16S, na.rm=TRUE)) %>% 
  ungroup()
```

### Growth rate vs did death happen at all

Hypothesis: Taxa with faster growth rates more likely to experience death afterwards
* boom/bust lifestyle
* didn't sample enough/long enough to capture slower grower death

```{r}
# Presence/absence of death in growing ASVs
no_death_asv <- anti_join(growth_asv, death_asv_log, by=c("ASV", "Soil", "Amendment")) %>% 
  add_column(died ="no")

growth_death_asv <- growth_death_asv %>% 
  add_column(died="yes")

# Include ASVs without detected death after growth
all_asv <- bind_rows(no_death_asv, growth_death_asv) %>% 
  mutate()
```

```{r}
# Graph
all_asv %>% 
  ggplot(aes(x=died, y=log(k))) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  facet_wrap(Soil~Amendment) +
  theme_test()
```

Greater variability and sample size of taxa that did not have estimated death after growth. Dificult to say whether this difference in variation/growth rate is real or due to undersampling.

### Growth rate vs logarithmic or linear growth detected

```{r}
growth_death_asv %>% 
  ggplot(aes(x=decay, y=log(k))) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  theme_test()
```

Not much to say here.

### Growth change abundance vs death yes/no

Hypothesis: Taxa that grew more biomass more likely to experience death afterwards
* boom/bust lifestyle
* didn't sample enough/long enough to slower/less growth and death

```{r}
# Graph
all_asv %>% 
  ggplot(aes(x=died, y=log(growth_change_abund_corr))) +
  geom_boxplot() +
  geom_jitter(alpha=0.5) +
  facet_wrap(Soil~Amendment) +
  theme_test()
```

Same interpretation. If there are any trends, they are slight.

### Growth rate vs death rate

Logarithmic only

Hypothesis: Taxa with faster growth rate more likely to experience faster death
* boom/bust lifestyle

```{r}
# Graph
growth_death_asv %>% 
  mutate(decay=="logarithmic") %>% 
  ggplot(aes(x=log(k), y=log(abs(death_rate)))) +
  geom_smooth(method="lm", linetype=2, alpha=0.5) +
  geom_point(alpha=0.5) +
  facet_wrap(Soil~Amendment) +
  theme_test()
```

Perhaps a trend of slight positive relationship.

**Statistics**

Pearson correlations with multiple test correction

```{r}
# Treatments
growthrate_deathrate_pcor_trts <- data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data_sub <- filter(growth_death_asv, Soil==s & Amendment==a & decay=="logarithmic")
    pcor <- cor.test(data_sub$k, abs(data_sub$death_rate), method="pearson")
    this_row <-  data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    growthrate_deathrate_pcor_trts <- bind_rows(growthrate_deathrate_pcor_trts, this_row)
  }
}

# Multiple test correction
padj <- p.adjust(growthrate_deathrate_pcor_trts$pvalue, method="holm", n=4)
growthrate_deathrate_pcor_trts <- bind_cols(growthrate_deathrate_pcor_trts, padj=padj)

# Results
growthrate_deathrate_pcor_trts
```

No significance.

### Growth rate vs death change in abundance

Logarithmic only

```{r}
# Graph
growth_death_asv %>% 
  mutate(decay=="logarithmic") %>% 
  ggplot(aes(x=log(k), y=log(abs(death_change_abund_corr)))) +
  geom_smooth(method="lm", linetype=2, alpha=0.5) +
  geom_point(alpha=0.5) +
  facet_wrap(Soil~Amendment) +
  theme_test()
```

### Growth change in abundance vs death rate

Logarithmic only

Hypothesis: Taxa that grew more more likely to experience faster death
* boom/bust lifestyle

```{r}
# Graph
growth_death_asv %>% 
  mutate(decay=="logarithmic") %>% 
  ggplot(aes(x=log(growth_change_abund_corr), y=log(abs(death_rate)))) + # cannot take ln of negative number
  geom_point(alpha=0.5) +
  geom_smooth(method="lm", linetype=2, alpha=0.5) +
  facet_wrap(Soil~Amendment) +
  theme_test()
```

Possibly slight positive correlation in amended soils but negative in unamended? This would mean that in unamended soils, as the change in growth biomass increased, the death rate tended to be lower, but in the amended soils, the opposite was true.

**Statistics**

Pearson correlations with multiple test correction

```{r}
# Treatments
grchabund_deathrate_pcor_trts <- data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data_sub <- filter(growth_death_asv, Soil==s & Amendment==a & decay=="logarithmic")
    pcor <- cor.test(log(data_sub$growth_change_abund_corr), log(abs(data_sub$death_rate)), method="pearson")
    this_row <-  data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    grchabund_deathrate_pcor_trts <- bind_rows(grchabund_deathrate_pcor_trts, this_row)
  }
}

# Multiple test correction
padj <- p.adjust(grchabund_deathrate_pcor_trts$pvalue, method="holm", n=4)
grchabund_deathrate_pcor_trts <- bind_cols(grchabund_deathrate_pcor_trts, padj=padj)

# Results
grchabund_deathrate_pcor_trts
```

No significance.

### Growth change in abundance vs death change in abundance

Logarithmic only

Hypothesis: Taxa that accumulated more biomass during growth can and will lose more biomass to death
* boom/bust lifestyle

```{r}
# Graph
growth_death_asv %>%
  mutate(decay=="logarithmic") %>% 
  filter(died=="yes") %>%
  ggplot(aes(x=log(growth_change_abund_corr), y=log(abs(death_change_abund_corr)))) +
  geom_point(alpha=0.5) +
  geom_smooth(method="lm", linetype=2, alpha=0.5) +
  facet_wrap(Soil~Amendment) +
  theme_test()
```

Positive correlation between change in abundance due to death and growth? If a taxa grew more, it died more. There also seems to be a treatment effect but this could be due to undersampling things that grew then died in the unammended soil.

**Statistics**

Pearson correlations with multiple test correction

```{r}
# Treatments
chabund_growth_death_pcor <- data.frame()
for (s in c("C3", "S17")) {
  for (a in c("Y", "N")) {
    data_sub <- filter(growth_death_asv, Soil==s & Amendment==a & decay=="logarithmic")
    pcor <- cor.test(log(data_sub$growth_change_abund_corr), log(abs(data_sub$death_change_abund_corr)), method="pearson")
    this_row <-  data.frame("Soil"=s, "Amendment"=a, "estimate"=pcor$estimate, "pvalue"=pcor$p.value)
    chabund_growth_death_pcor <- bind_rows(chabund_growth_death_pcor, this_row)
  }
}

# Multiple test correction
padj <- p.adjust(chabund_growth_death_pcor$pvalue, method="holm", n=4)
chabund_growth_death_pcor_trts <- bind_cols(chabund_growth_death_pcor, padj=padj)

# Results
chabund_growth_death_pcor
```

Positive correlation between growth and death change in abundance in amended but not unamended soil. More growth means more potential for losses to death?

# Figures

Aggregate death change in abundance

```{r}
plot <- growth_death_agg_log %>% 
   mutate(Soil = fct_recode(Soil, Cropped = "C3", Successional = "S17"),
          Amendment = as_factor(Amendment),
         Amendment = fct_recode(Amendment, Resources = "Y", Water = "N"),
         Amendment = fct_relevel(Amendment, c("Resources", "Water"))) %>% 
  ggplot(aes(x=Soil, y=abs(death_change_abund_corr))) +
  geom_jitter(aes(shape=Amendment), width=0.1) +
  scale_shape_manual(values=c(19,1)) +
  theme_classic() +
  theme(axis.title = element_blank(),
        text = element_text(size=9),
        strip.text.x = element_text(size = 10, hjust = 0),
        legend.position = "bottom",
        strip.background = element_blank())
plot
```

```{r, eval=FALSE}
ggsave(plot, filename="../figures/suppfig_deathchabund_aggregate.svg", units="mm", width=70, height=60, device="svg")
```

Growth vs death change in abundance

```{r}
plot <- growth_death_asv %>%
  mutate(Treatment = paste0(Soil, Amendment),
         Treatment = fct_recode(Treatment, 'Cropped, water' = "C3N", 'Cropped, resources' = "C3Y",
                                'Successional, water' = "S17N", 'Successional, resources' = "S17Y"),
         Treatment = factor(Treatment, levels=c("Cropped, water", "Cropped, resources",
                                                 "Successional, water", "Successional, resources"))) %>%
  mutate(decay=="logarithmic") %>% 
  filter(died=="yes") %>%
  ggplot(aes(x=log(growth_change_abund_corr), y=log(abs(death_change_abund_corr)))) +
  geom_point(shape=1, alpha= 0.5) +
  geom_smooth(method="lm", linetype=2, color="black", alpha=0.5) +
  facet_wrap(~Treatment) +
  theme_test() +
  theme(text = element_text(size=9),
        strip.text.x = element_text(size = 9, hjust = 0),
        strip.background = element_blank(),
        axis.title = element_blank())
plot
```

```{r, eval=FALSE}
ggsave(plot, filename = "../figures/fig_growthxdeathchabund.svg", units="mm", width=85, height=90, device="svg")
```


