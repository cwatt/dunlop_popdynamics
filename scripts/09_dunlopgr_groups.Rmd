---
title: "Dunlop growth rates - groups"
author: "Cassandra Wattenburger"
date: "3/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** Growth rate distributions seem bimodal. See if groups can be explicitly modeled and explore relationships with other variables.

# Import libraries

```{r}
library(tidyverse)
library(mclust)

sessionInfo()

rm(list=ls())

set.seed(2) # mclust uses EM algorhythm which is iterative and random
```

# Import data

```{r}
growth <- readRDS("../rdata.files/gr_gr.paprica.clean.rds")
```

Average across replicates to get a single estimated growth rate for each taxa in each treatment.

```{r}
# Average across replicates for each ASV
growth.asv <- growth %>%
  group_by(Soil, Amendment, ASV) %>%
  summarize(k = mean(k),
            start_day = mean(start_day),
            end_day = mean(end_day),
            start_abund = mean(start_abund),
            end_abund = mean(end_abund)) %>% 
  ungroup()

# Including PAPRICA results
# Have to remove archaea because they weren't predicted by program (NAs)
growth.paprica.asv <- growth %>%
  na.omit() %>%
  group_by(Soil, Amendment, ASV) %>%
  summarize(k = mean(k),
            start_day = mean(start_day),
            end_day = mean(end_day),
            start_abund = mean(start_abund),
            end_abund = mean(end_abund),
            n16S = mean(n16S),
            genome_size = mean(genome_size)) %>% 
  ungroup()
```


Visualize distributions:

```{r}
# Averaged across replicates
growth.asv %>%
  ggplot(aes(x=log(k), color=Soil)) +
  geom_density() +
  facet_wrap(~Amendment) +
  theme_test()
```

# Fit models and cluster

### Successional water control

```{r}
# Subset
S17n <- growth.asv %>% 
  filter(Soil=="S17" & Amendment=="N")

# Fit univariate gaussian mixture model
S17n.mclust <- densityMclust(log(S17n$k))
summary(S17n.mclust)
plot(S17n.mclust$BIC)
S17n.mclust$parameters
plot(S17n.mclust, what = "density", data = log(S17n$k))

# Bootstrap CIs of parameters
S17n.boot <- MclustBootstrap(S17n.mclust, nboot=999, type="bs", verbose=FALSE)
summary(S17n.boot, what = "ci")
plot(S17n.boot, what = "mean")

# Add classifications
S17n.class <- S17n %>%
  add_column(classification = S17n.mclust$classification) %>%
  mutate(classification = as_factor(classification))

S17n.class %>% 
  ggplot(aes(x=log(k), color=classification)) +
  geom_histogram() +
  theme_test()
```


### Cropped water control

```{r}
# Subset
C3n <- growth.asv %>% 
  filter(Soil=="C3" & Amendment=="N")

# Fit univariate gaussian mixture model
C3n.mclust <- densityMclust(log(C3n$k))
summary(C3n.mclust)
plot(C3n.mclust$BIC)
C3n.mclust$parameters
plot(C3n.mclust, what = "density", data = log(C3n$k))

# Bootstrap CIs of parameters
C3n.boot <- MclustBootstrap(C3n.mclust, nboot=999, type="bs", verbose=FALSE)
summary(C3n.boot, what = "ci")
plot(C3n.boot, what = "mean")

# Add classifications
C3n.class <- C3n %>%
  add_column(classification = C3n.mclust$classification) %>%
  mutate(classification = as_factor(classification))

C3n.class %>% 
  ggplot(aes(x=log(k), color=classification)) +
  geom_histogram() +
  theme_test()
```


### Successional C-amended

```{r}
# Subset
S17y <- growth.asv %>% 
  filter(Soil=="S17" & Amendment=="Y")

# Fit univariate gaussian mixture model
S17y.mclust <- densityMclust(log(S17y$k))
summary(S17y.mclust)
plot(S17y.mclust$BIC)
S17y.mclust$parameters
plot(S17y.mclust, what = "density", data = log(S17y$k))

# Bootstrap CIs of parameters
S17y.boot <- MclustBootstrap(S17y.mclust, nboot=999, type="bs", verbose=FALSE)
summary(S17y.boot, what = "ci")
plot(S17y.boot, what = "mean")

# Add classifications
S17y.class <- S17y %>%
  add_column(classification = S17y.mclust$classification) %>%
  mutate(classification = as_factor(classification))

S17y.class %>% 
  ggplot(aes(x=log(k), color=classification)) +
  geom_histogram() +
  theme_test()
```

### Cropped C-amended

```{r}
# Subset
C3y <- growth.asv %>% 
  filter(Soil=="C3" & Amendment=="Y")

# Fit univariate gaussian mixture model
C3y.mclust <- densityMclust(log(C3y$k))
summary(C3y.mclust)
plot(C3y.mclust$BIC)
C3y.mclust$parameters
plot(C3y.mclust, what = "density", data = log(C3y$k))
C3y.boot <- MclustBootstrap(C3y.mclust, nboot=999, type="bs", verbose=FALSE)

# Add classifications
C3y.class <- C3y %>%
  add_column(classification = C3y.mclust$classification) %>%
  mutate(classification = as_factor(classification))
```

It looks like a model with a single distribution best fits this treatment, rather than 2 distributions.

# Cluster traits

```{r}
S17n_clusters <- S17n %>% 
  add_column(cluster=S17n.mclust$classification) %>% 
  mutate(cluster = if_else(cluster==1, "slow", "fast"))

S17y_clusters <- S17y %>% 
  add_column(cluster=S17y.mclust$classification) %>% 
  mutate(cluster = if_else(cluster==1, "slow", "fast"))

C3n_clusters <- C3n %>% 
  add_column(cluster=C3n.mclust$classification) %>% 
  mutate(cluster = if_else(cluster==1, "slow", "fast"))

C3y_clusters <- C3y %>% 
  add_column(cluster=C3y.mclust$classification) %>% 
  mutate(cluster = "intermediate")

# Combine
growth_clusters <- bind_rows(S17n_clusters, S17y_clusters) %>% 
  bind_rows(C3n_clusters) %>% 
  bind_rows(C3y_clusters)
```

## Growth traits

* lag time, 16S copy #, change in abundance

```{r}

```

## Shift vs replacement

```{r}

```

## Diversity

```{r}
#kernel density graphs?
```




# Figures

## Cluster densities

Code to create and plot clusters borrowed from https://github.com/jlw-ecoevo/eggo/blob/master/Scripts/RefSeq_Analysis.R

```{r}
# Generate clusters for graphing, scaled to proportion
C3n.clusters <- data.frame(x = seq(-5,0.5,0.01),
                    cl1 = dnorm(seq(-5,0.5,0.01),
                              mean = C3n.mclust$parameters$mean[1],
                              sd = sqrt(C3n.mclust$p$variance$sigmasq))*C3n.mclust$parameters$pro[1],
                    cl2 = dnorm(seq(-5,0.5,0.01),
                              mean = C3n.mclust$parameters$mean[2],
                              sd = sqrt(C3n.mclust$p$variance$sigmasq))*C3n.mclust$parameters$pro[2])

# Plot
plot1 <- growth.asv %>%
  filter(Soil=="C3", Amendment=="N") %>%
  ggplot() +
  geom_polygon(data=C3n.clusters, aes(x=x, y=cl1), linetype=2, alpha=0.6, color="black", fill="blue") +
  geom_polygon(data=C3n.clusters, aes(x=x, y=cl2), linetype=2, alpha=0.6, color="black", fill="red") +
  geom_density(aes(x=log(k))) +
  labs(title="Cropped, water", y="Kernel density", x="Specific growth rate (units), ln") +
  ylim(0,1) +
  theme_classic() +
  theme(plot.title = element_text(size=9),
        text = element_text(size=9),
        strip.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.title = element_blank())
plot1
```

```{r}
# Generate clusters for graphing, scaled to proportion
C3y.clusters <- data.frame(x = seq(-5,0.5,0.01),
                    cl1 = dnorm(seq(-5,0.5,0.01),
                              mean = C3y.mclust$parameters$mean[1],
                              sd = sqrt(C3y.mclust$parameters$variance$sigmasq)))

# Plot
plot2 <- growth.asv %>%
  filter(Soil=="C3", Amendment=="Y") %>%
  ggplot() +
  geom_polygon(data=C3y.clusters, aes(x=x, y=cl1), linetype=2, alpha=0.6, color="black", fill="purple") +
  geom_density(aes(x=log(k))) +
  labs(title="Cropped, resources", y="Kernel density", x="Specific growth rate (units), ln") +
  ylim(0,1) +
  theme_classic() +
  theme(plot.title = element_text(size=9),
        text = element_text(size=9),
        strip.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.title = element_blank())
plot2
```

```{r}
# Generate clusters for graphing, scaled to proportion
S17n.clusters <- data.frame(x = seq(-5,0.5,0.01),
                    cl1 = dnorm(seq(-5,0.5,0.01),
                              mean = S17n.mclust$parameters$mean[1],
                              sd = sqrt(S17n.mclust$p$variance$sigmasq[1]))*S17n.mclust$parameters$pro[1],
                    cl2 = dnorm(seq(-5,0.5,0.01),
                              mean = S17n.mclust$parameters$mean[2],
                              sd = sqrt(S17n.mclust$p$variance$sigmasq[2]))*S17n.mclust$parameters$pro[2])

# Plot
plot3 <- growth.asv %>%
  filter(Soil=="S17", Amendment=="N") %>%
  ggplot() +
  geom_polygon(data=S17n.clusters, aes(x=x, y=cl1), linetype=2, alpha=0.6, color="black", fill="blue") +
  geom_polygon(data=S17n.clusters, aes(x=x, y=cl2), linetype=2, alpha=0.6, color="black", fill="red") +
  geom_density(aes(x=log(k))) +
  labs(title="Successional, water", y="Kernel density", x="Specific growth rate (units), ln") +
  ylim(0,0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=9),
        text = element_text(size=9),
        strip.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.title = element_blank())
plot3
```

```{r}
# Generate clusters for graphing, scaled to proportion
S17y.clusters <- data.frame(x = seq(-5,0.5,0.01),
                    cl1 = dnorm(seq(-5,0.5,0.01),
                              mean = S17y.mclust$parameters$mean[1],
                              sd = sqrt(S17y.mclust$p$variance$sigmasq[1]))*S17y.mclust$parameters$pro[1],
                    cl2 = dnorm(seq(-5,0.5,0.01),
                              mean = S17y.mclust$parameters$mean[2],
                              sd = sqrt(S17y.mclust$p$variance$sigmasq[2]))*S17y.mclust$parameters$pro[2])

# Plot
plot4 <- growth.asv %>%
  filter(Soil=="S17", Amendment=="Y") %>%
  ggplot() +
  geom_polygon(data=S17y.clusters, aes(x=x, y=cl1), linetype=2, alpha=0.6, color="black", fill="blue") +
  geom_polygon(data=S17y.clusters, aes(x=x, y=cl2), linetype=2, alpha=0.6, color="black", fill="red") +
  geom_density(aes(x=log(k))) +
  labs(title="Successional, resources", y="Kernel density", x="Specific growth rate (units), ln") +
  ylim(0,0.7) +
  theme_classic() +
  theme(plot.title = element_text(size=9),
        text = element_text(size=9),
        strip.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.title = element_blank())
plot4
```

```{r}
library(cowplot)
figure <- plot_grid(plot1, plot2, plot3, plot4)
figure

ggsave(figure, filename="../figures/fig_groups.svg", units="mm", width=85, height=85, device="svg")
```

## BIC values

```{r}
C3n.bic <- data.frame(Clusters = 1:9, E = C3n.mclust$BIC[,1], V = C3n.mclust$BIC[,2]) %>% 
  pivot_longer(cols = -Clusters, names_to = "Model", values_to="BIC") %>% 
  add_column(Treatment = "Cropped, water")

C3y.bic <- data.frame(Clusters = 1:9, E = C3y.mclust$BIC[,1], V = C3y.mclust$BIC[,2]) %>% 
  pivot_longer(cols = -Clusters, names_to = "Model", values_to="BIC") %>% 
  add_column(Treatment = "Cropped, resources")

S17n.bic <- data.frame(Clusters = 1:9, E = S17n.mclust$BIC[,1], V = S17n.mclust$BIC[,2]) %>% 
  pivot_longer(cols = -Clusters, names_to = "Model", values_to="BIC") %>% 
  add_column(Treatment = "Successional, water")

S17y.bic <- data.frame(Clusters = 1:9, E = S17y.mclust$BIC[,1], V = S17y.mclust$BIC[,2]) %>% 
  pivot_longer(cols = -Clusters, names_to = "Model", values_to="BIC") %>% 
  add_column(Treatment = "Successional, resources")

all.bic <- bind_rows(C3n.bic, C3y.bic, S17n.bic, S17y.bic)

plot_bic <- all.bic %>% 
  ggplot(aes(shape=Model, x=Clusters, y=BIC)) +
  geom_point() +
  geom_line(aes(linetype=Model)) +
  facet_wrap(~Treatment, scales="free") +
  labs(x="Number of clusters") +
  scale_x_continuous(breaks = seq(1, 9, by = 1)) +
  theme_test()
plot_bic

ggsave(plot_bic, filename = "../figures/suppfig_bic.svg", units="mm", width=140, height=100, device="svg")
```

## Bootstrapped cluster means

```{r}
# Succesional water only
S17n.boot.mean <- S17n.boot$mean %>% as.data.frame()
colnames(S17n.boot.mean) <- c("slow", "fast")
S17n.boot.mean <- S17n.boot.mean %>% 
  add_column(Soil="Successional",
             Amendment="Water only",
             intermediate=NA) %>% 
  select(Soil, Amendment, slow, fast, intermediate)

# Succesional resources + water
S17y.boot.mean <- S17y.boot$mean %>% as.data.frame()
colnames(S17y.boot.mean) <- c("slow", "fast")
S17y.boot.mean <- S17y.boot.mean %>% 
  add_column(Soil="Successional",
             Amendment="Resources + Water",
             intermediate=NA) %>% 
  select(Soil, Amendment, slow, fast, intermediate)

# Cropped water only
C3n.boot.mean <- C3n.boot$mean %>% as.data.frame()
colnames(C3n.boot.mean) <- c("slow", "fast")
C3n.boot.mean <- C3n.boot.mean %>% 
  add_column(Soil="Cropped",
             Amendment="Water only",
             intermediate=NA) %>% 
  select(Soil, Amendment, slow, fast, intermediate)

# Cropped resources + water
C3y.boot.mean <- C3y.boot$mean %>% as.data.frame()
colnames(C3y.boot.mean) <- c("intermediate")
C3y.boot.mean <- C3y.boot.mean %>% 
  add_column(Soil="Cropped",
             Amendment="Resources + Water",
             fast=NA,
             slow=NA) %>% 
  select(Soil, Amendment, slow, fast, intermediate)

# Combine
boot_mean_all <- add_row(S17n.boot.mean, S17y.boot.mean) %>% 
  add_row(C3n.boot.mean) %>% 
  add_row(C3y.boot.mean)

# Long format
boot_mean_all <- boot_mean_all %>% 
  pivot_longer(slow:intermediate, names_to="cluster", values_to="mean")
```

Visualize:

```{r}
plot_bootstrap <- boot_mean_all %>% 
  mutate(name=paste0(Soil, ", ", Amendment, ", ", cluster)) %>% 
  ggplot(aes(x=Soil, y=mean, color=cluster)) +
  geom_boxplot() +
  facet_wrap(~Amendment) +
  labs(x="", y="Bootstrapped means (ln specific growth rate) ") +
  scale_color_manual(values=c("blue", "purple", "red")) +
  theme_test() 
plot_bootstrap
```

```{r, eval=FALSE}
ggsave(plot_bootstrap, filename = "../figures/suppfig_meanboot.svg", units="mm", width=140, height=100, device="svg")
```



