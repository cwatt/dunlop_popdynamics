---
title: "Dunlop growth rates - start abundance"
author: "Cassandra Wattenburger"
date: "2/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** Investigate relationship between abundance in community and growth rate.

Hypothesis: Faster growing taxa will have lower initial abundances, reflecting boom-bust life strategy.

# Import libraries

```{r}
library(tidyverse)
library(lmerTest)
library(emmeans)

sessionInfo()

rm(list=ls())
```

# Set up

Import data with field and microcosm abundances, and growth rate estimates.

```{r}
# Field abundances
field = readRDS("rdata.files/field.norm.cleaned.rds")

# Average abundance across replicates
field.avg = field %>%
  group_by(Soil, ASV, Phylum, Class, Order, Family, Genus) %>%
  summarize(norm_abund_avg = mean(norm_abund))
  
# Ucosm abundances
ucosm = readRDS("rdata.files/ucosm.norm.cleaned.rds")

# Average abundance across replicates
ucosm.avg = ucosm %>%
  filter(Day==0) %>% # only interested in starting conditions
  group_by(Soil, Amendment, ASV, Phylum, Class, Order, Family, Genus) %>%
  summarize(norm_abund_avg = mean(norm_abund))

# Estimated growth rates
gr.est = readRDS("rdata.files/gr.final.cleaned.rds")

# Average growth rate for each ASV
gr.est.avg = gr.est %>%
  group_by(Soil, Amendment, ASV) %>%
  summarize(k_avg = mean(k))

# Merge data frames
# Field abundances with growth rate estimates from C-amended treatment
field.gr.y = gr.est.avg %>%
  filter(Amendment=="Y") %>%
  inner_join(field.avg, by=c("Soil", "ASV"))
  
# Field abundances with growth rate estimates from water-amended treatment
field.gr.n = gr.est.avg %>%
  filter(Amendment=="N") %>%
  inner_join(field.avg, by=c("Soil", "ASV"))

# Rejoin field data
field.gr = bind_rows(field.gr.y, field.gr.n)

# Microcosm abundances with growth rate estimates
ucosm.gr = gr.est.avg %>%
  inner_join(ucosm.avg, by=c("Soil", "Amendment", "ASV"))

```

**Visualize**

```{r}
# Field
field.gr %>%
  ggplot(aes(x=log(k_avg), y=log(norm_abund_avg))) +
  geom_boxplot() +
  geom_point() +
  facet_wrap(Soil~Amendment) +
  labs(title = "Field") +
  theme_test()

# Ucosms
ucosm.gr %>%
  ggplot(aes(x=log(k_avg), y=log(norm_abund_avg))) +
  geom_boxplot() +
  geom_point() +
  facet_wrap(Soil~Amendment) +
  labs(title = "Microcosms") +
  theme_test()

ucosm.gr %>%
  ggplot(aes(x=log(k_avg), y=log(norm_abund_avg))) +
  geom_boxplot() +
  geom_point() +
  facet_wrap(~Amendment) +
  labs(title = "Microcosms") +
  theme_test()

```

No apparent correlation between start abundance and growth rate. However, in microcosms, it looks like taxa that grew in C-amended treatment may have started at higher abundance to begin with? This might be indicative of a high-biomass strategy that is better able to compete for available resources when they appear.

# Statistics

Mixed linear regression
 
* Soil and amendments as maine effects, no interaction visible so won't incorporate
* ASV as random effect

```{r}
# Mixed linear regression
ucosm.lmer = lmer(norm_abund_avg ~ Soil + Amendment + (1|ASV), data=ucosm.gr)
hist(residuals(ucosm.lmer)) # check normality of model residuals
```

Nooooo. Log transform.

```{r}
# Remove 0s (can't log transform) is there a better way than this? impute?
ucosm.gr.rm0 = ucosm.gr %>%
  filter(norm_abund_avg > 0)

# Mixed linear regression
ucosm.lmer2 = lmer(log(norm_abund_avg) ~ Soil + Amendment + (1|ASV), data=ucosm.gr.rm0) # problem = can't log transform 0s. should i impute or remove????
hist(residuals(ucosm.lmer2)) # check normality of model residuals
plot(residuals(ucosm.lmer2), predict(ucosm.lmer2)) # check heteroskedasticity
```

What is UP with that heteroskedasticity

Continue...

* start abund vs change abund, expect no relationship b/c biomass could grow a lot but so could boom bust

