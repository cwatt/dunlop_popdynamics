---
title: "exploration - mclust
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(results = "show")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

**Goal of this script:** See how mclust works for modeling finite mixtures and clustering.


# Import libraries

```{r}
library(tidyverse)
library(mclust)

sessionInfo()

rm(list=ls())
```


# Import growth metric data

```{r}
growth <- readRDS("rdata.files/gr_gr.paprica.clean.rds")
```

Average across replicates to get a single growth estimate for each ASV

```{r}
# Average across replicates for each ASV
growth.asv <- growth %>%
  group_by(Soil, Amendment, ASV) %>%
  summarize(k = mean(k),
            start_day = mean(start_day),
            end_day = mean(end_day),
            start_abund = mean(start_abund),
            end_abund = mean(end_abund))

# Including PAPRICA results
# Have to remove archaea because they weren't predicted
growth.paprica.asv <- growth %>%
  na.omit() %>%
  group_by(Soil, Amendment, ASV) %>%
  summarize(k = mean(k),
            start_day = mean(start_day),
            end_day = mean(end_day),
            start_abund = mean(start_abund),
            end_abund = mean(end_abund),
            n16S = mean(n16S),
            genome_size = mean(genome_size))
```

Visual of growth rate distributions:

```{r}
growth.asv %>%
  ggplot(aes(x=log(k), color=Soil)) +
  geom_density() +
  facet_wrap(~Amendment) +
  theme_test()
```

There seems to be bimodality occuring in each distribution to some extent. Let's see if we can model this and cluster into groups for further analysis.


### Subsetting data

Choose soil and amendment type in chunk below

```{r}
# Isolate treatment
sub.data <- growth.asv %>% 
  filter(Soil=="S17" & Amendment=="Y")
```


Fit gaussian mixture model

* Mclust will choose best number of clusters and equal or unequal variances based on BIC values

```{r}
# EM algorithm used for model fitting is iterative, so set a seed
set.seed(2)

# Use mclust to fit gaussian mixture model and cluster
# Choosing to fit equal variance models for all treatments, based on observation of graph and mean parameter
sub.data.model <- Mclust(log(sub.data$k))
summary(sub.data.model)
sub.data.model$parameters

# Plot BIC for model parameters
plot(sub.data.model, what = c("BIC"), 
     dimens = NULL, xlab = NULL, ylab = NULL,
     addEllipses = TRUE, main = FALSE)

# Plot classifications
plot(sub.data.model, what = c("classification"), 
     dimens = NULL, xlab = NULL, ylab = NULL,
     addEllipses = TRUE, main = FALSE)

# Plot uncertainty
plot(sub.data.model, what = c("uncertainty"), 
     dimens = NULL, xlab = NULL, ylab = NULL,
     addEllipses = TRUE, main = FALSE)
```

Assign each data point to its cluster

```{r}
length(sub.data.model$classification)
length(sub.data.model$data)

x <- sub.data %>%
  add_column(cluster = sub.data.model$classification) %>%
  mutate(cluster = as.factor(cluster))

x %>%
  ggplot(aes(x=cluster, y=log(k))) +
  geom_point() +
  theme_test()

x %>% group_by(cluster) %>% summarize(min = min(k), max = max(k))
```

It looks like mclust assigns data to clusters by truncating distributions, which is what I wanted to avoid doing. It also seems to be fitting the data less well compared to the mixtools package, based on observations of graphs and log liklihood estimates. I'll put this package aside for now.

