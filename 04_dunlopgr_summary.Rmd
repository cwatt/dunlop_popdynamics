---
title: "Dunlop growth rates - data exploration and summary statistics"
author: "Cassandra Wattenburger"
date: "11/10/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(results = "show")
```

**Goal of this script:** Explore the properties of the data and descriptive statistics of in-situ growth rates.

# Import libraries

```{r}
library(tidyverse)
library(cowplot)
library(phyloseq)
library(lmerTest)
library(emmeans)

sessionInfo()

rm(list=ls())
```

# Load data and clean up

There are inconsistencies in the data structure, variable names, and metadata that need to be cleaned up for easier manipulation and analysis.

Internal-standard normalized microcosm and field community data:

```{r}
# Original, rarefied phyloseq object (not normalized)
load("rdata.files/gr_physeq.rarefy.RData")
tax = as.data.frame(tax_table(physeq.rarefy)) %>% rownames_to_column(var="ASV") # taxonomy extract

# Microcosms
load("rdata.files/gr_microcosm.norm.tax.RData")
ucosms = microcosm.norm.tax

# Replicates
ucosm.rep1 = seq(81, 260, by=3)
ucosm.rep2 = seq(82, 260, by=3)
ucosm.rep3 = seq(83, 260, by=3)

# Clean up
ucosms = ucosms %>% 
  mutate(Sample = str_remove(SampleID, "sa"), Sample = parse_number(Sample)) %>% # convert sample numbers into numeric (easier manipulation)
  mutate(Replicate = ifelse(Sample %in% ucosm.rep1, 1, ifelse(Sample %in% ucosm.rep2, 2, ifelse(Sample %in% ucosm.rep3, 3, NA)))) %>% # add replicates
  select(Sample, Amendment=Cammend, Soil, Day=Days, Replicate, norm_abund=value, ASV=variable, Domain, Phylum, Class, Order, Family, Genus) # rename/reorder

# Field
load("rdata.files/gr_field.norm.RData")
field = field.norm

# Replicates
field.rep1 = seq(1, 80, by=4)
field.rep2 = seq(2, 80, by=4)
field.rep3 = seq(3, 80, by=4)
field.rep4 = seq(4, 80, by=4)

# Clean up
field = field %>%
  mutate(Sample = str_remove(SampleID, "sa"), Sample = parse_number(Sample)) %>% # convert sample numbers into numeric (easier manipulation)
  pivot_longer(9:33122, names_to = "ASV", values_to="norm_abund") %>% # tidy format
  filter(Soil %in% c("C3", "S17")) %>% # only these plots are relevant
  mutate(Replicate = ifelse(Sample %in% field.rep1, 1, ifelse(Sample %in% field.rep2, 2, ifelse(Sample %in% field.rep3, 3, ifelse(Sample %in% field.rep4, 4, NA))))) %>% # add replciates
  select(Sample, Soil, Block, Replicate, ASV, norm_abund) %>% # rename/reorder
  left_join(tax, by="ASV") # add taxonomy
```

Number of ASVs/phyla in dataset

```{r}
# Extract from phyloseq
count = as.data.frame(otu_table(physeq.rarefy))
meta = data.frame(sam_data(physeq.rarefy))

# Remove unused samples
## Only microcosm adn S17/C3 from field relevant
meta.rm = meta %>% subset(Soil == "C3" | Soil == "S17")

count.rm = count %>%
  t() %>%
  as.data.frame() %>%
  merge(meta.rm, by=0) %>%
  column_to_rownames(var="Row.names") %>%
  select(everything(), -(SampleID:Experiment))

# Remove absent ASVs
count.rm0 = colSums(count.rm, dims=1)
count.rm0 = count.rm0[count.rm0 > 0]

# Total ASVs
length(count.rm0)
asvs = names(count.rm0)

# Total phyla
tax.rm0 = tax[tax$ASV %in% asvs,]
phyla = unique(tax.rm0$Phylum)
```


Estimated in-situ growth rates:

```{r}
gr.est = readRDS("rdata.files/gr_gr.final_rm0.rds")

# Clean up
gr.est = gr.est %>% 
  left_join(tax, by="ASV") %>% # add taxonomy
  select(Soil, Amendment, Replicate, label, Slope, k, g, Start, End, Length, ASV, Domain, Phylum, Class, Order, Family, Genus) # rename/reorder
```

```{r, eval=FALSE}
# Save cleaned datasets for use in future scripts
saveRDS(ucosms, file="rdata.files/ucosm.norm.cleaned.rds")
saveRDS(field, file="rdata.files/field.norm.cleaned.rds")
saveRDS(gr.est, file="rdata.files/gr.final.cleaned.rds")
```


# Overview of communities

Number of ASVs/phyla

```{r}
# Microcosms
ucosms %>% filter(norm_abund != 0) %>% distinct(ASV) %>% nrow() # total ASVs (not including 0 abundance)

ucosms %>%  # average ASVs per sample
  filter(norm_abund != 0) %>% 
  group_by(Sample) %>% 
  summarize(num_ASV = length(unique(ASV))) %>% 
  colMeans()

ucosms %>% # total phyla, not counting 0 abundance ASVs, or uncertain taxonomic placement
  filter(norm_abund != 0) %>% 
  mutate(Phylum = str_remove(Phylum, "putative "), Phylum = str_remove(Phylum, "unclassified ")) %>%
  distinct(Phylum) %>% 
  nrow()

# Field
field %>% filter(norm_abund != 0) %>% distinct(ASV) %>% nrow() # total ASVs (not including 0 abundance)

field %>%  # average ASVs per sample
  filter(norm_abund != 0) %>% 
  group_by(Sample) %>% 
  summarize(num_ASV = length(unique(ASV))) %>% 
  colMeans()

field %>% # total phyla, not counting 0 abundance ASVs, or uncertain taxonomic placement
  filter(norm_abund != 0) %>% 
  mutate(Phylum = str_remove(Phylum, "putative "), Phylum = str_remove(Phylum, "unclassified ")) %>% 
  distinct(Phylum) %>% 
  nrow() 

# Microcosms and field together (full dataset)
ucosms %>% bind_rows(field) %>% filter(norm_abund != 0) %>% distinct(ASV) %>% nrow() # total ASVs (not including 0 abundance)

ucosms %>% # average number of ASVs
  bind_rows(field) %>% 
  filter(norm_abund != 0) %>% 
  group_by(Sample) %>% 
  summarize(num_ASV = length(unique(ASV))) %>% 
  colMeans()

ucosms %>% # total phyla, not counting 0 abundance ASVs, or uncertain taxonomic placement
  bind_rows(field) %>% 
  filter(norm_abund != 0) %>% 
  mutate(Phylum = str_remove(Phylum, "putative "), Phylum = str_remove(Phylum, "unclassified ")) %>%
  distinct(Phylum) %>% 
  nrow() 

# Estimated growth rates
gr.est %>% distinct(ASV) %>% nrow() # total ASVs (not including 0 abundance)

gr.est %>% # total phyla, not counting 0 abundance ASVs, not counting putative/unclassified
  mutate(Phylum = str_remove(Phylum, "putative "), Phylum = str_remove(Phylum, "unclassified ")) %>% 
  distinct(Phylum) %>% 
  nrow()

# Number of estimates per phylum
gr.est %>% 
  mutate(Phylum = str_remove(Phylum, "putative ")) %>% # roll putative into the phylum
  distinct(ASV, Phylum) %>%
  group_by(Phylum) %>%
  summarize(total = n()) %>%
  arrange(-total)

# Number of estimates per treatment
gr.est %>%
  group_by(Soil, Amendment) %>%
  distinct(ASV) %>%
  summarize(total = n())
```

Most abundant phyla

```{r}
# Microcosms (tp0)
ucosms %>% 
  filter(Day==0) %>%
  group_by(Replicate, Phylum) %>% 
  summarize(total_abund = sum(norm_abund)) %>%
  ggplot(aes(y=fct_reorder(Phylum, -total_abund), x=total_abund)) +
  geom_boxplot() +
  labs(title="Microcosms at TP0", x="Total normalized abundance", y="Phylum") +
  theme_test()

# Field
field %>% 
  group_by(Replicate, Phylum) %>% 
  summarize(total_abund = sum(norm_abund)) %>%
  ggplot(aes(y=fct_reorder(Phylum, -total_abund), x=total_abund)) +
  geom_boxplot() +
  labs(title="Field", x="Total normalized abundance", y="Phylum") +
  theme_test()

# Growth rate estimates
gr.est %>% 
  group_by(Replicate, Phylum) %>%
  summarize(num_ASV = length(ASV)) %>%
  ggplot(aes(y=fct_reorder(Phylum, -num_ASV), x=num_ASV)) +
  geom_boxplot() +
  labs(title="Growth estimates", x="Total ASVs", y="Phylum") +
  theme_test()

# Count total ASVs in overall data
gr.est %>% group_by(Phylum) %>% count(Phylum) %>% arrange(-n)
```

Top 5 most abundant phyla in all data categories are Proteobacteria, Actinobacteria, Acidobacteria, Verrucomicrobia, and Planctomycetes in that order.


# Biogeochemical data analysis

Analyze SOM and pH data collected from in-field samples.


### SOM

```{r}
# Import data
som = read_csv("biogeochem_data/growthrate_insitu_som.csv")
som = som %>% 
  filter((Soil=="S" & Year==17) | (Soil=="C" & Year==3)) %>%
  mutate(som = (Preignition - Postignition) / (Preignition - Crucible) * 100, # calculate % SOM
         Soil = parse_factor(Soil),
         Soil = recode_factor(Soil, C="Cropped", S="Successional")) # clean up

som %>% 
  ggplot(aes(x=Soil, y=som)) +
  geom_boxplot() +
  labs(y="Soil organic matter (%)") +
  theme_test()

som %>% 
  ggplot(aes(x=Soil, y=som)) +
  geom_boxplot() +
  facet_wrap(~Block) +
  labs(y="Soil organic matter (%)") +
  theme_test()
```

Strong block effect.

**Statistics**

Linear regression
* Soil and Block as fixed effects with interaction term

```{r}
som.lm = lm(som ~ Soil* Block, data=som)

hist(resid(som.lm))
plot(resid(som.lm), predict(som.lm))

som.lm2 = lm(log(som) ~ Soil* Block, data=som)

hist(resid(som.lm2))
plot(resid(som.lm2), predict(som.lm2))
```

Neither of the residuals look like they fit the assumptions of the linear model... I'll do a welch's t-tests instead, since it looks like unequal variances seem to be the issue. I can't add interaction term, so we'll do a separate test for each block to account for the interaction.

Welch's t-tests

```{r}
t.test(som ~ Soil, data=som[som$Block==1,], var.equal=FALSE) # block 1 only
t.test(som ~ Soil, data=som[som$Block==2,], var.equal=FALSE) # block 2 only
```

SOM is signficant between soils in block 2 but not block 1. Likely due to block 2 being downslope of block 1.


### pH

```{r}
# Import data
ph = read_csv("biogeochem_data/growthrate_insitu_ph.csv")
ph = ph %>% 
  filter((Soil=="S" & Year==17) | (Soil=="C" & Year==3)) %>%
  mutate(Soil = parse_factor(Soil),
         Soil = recode_factor(Soil, C="Cropped", S="Successional")) # clean up

ph %>% 
  ggplot(aes(x=Soil, y=pH)) +
  geom_boxplot() +
  labs(x="") +
  theme_test()

ph %>% 
  ggplot(aes(x=Soil, y=pH)) +
  geom_boxplot() +
  facet_wrap(~Block) +
  labs(x="") +
  theme_test()
```

Also looks like there is a strong block effect here.


**Statistics**

Linear regression
* Soil and Block as fixed effects with interaction term

```{r}
ph.lm = lm(pH ~ Soil*Block, data=ph)

hist(resid(ph.lm)) # check normality
plot(resid(ph.lm), predict(ph.lm)) # check variances

summary(ph.lm)
```

There is a significant soil, block, and interaction between block and soil for pH.


### Make table of results

```{r}
# Merge SOM and pH data
som.ph = full_join(som, ph) %>%
  group_by(Soil) %>%
  summarize(som.avg = mean(som, na.rm=TRUE), som.sd = sd(som, na.rm=TRUE),
            ph.avg = mean(pH, na.rm=TRUE), ph.sd = sd(pH, na.rm=TRUE))
som.ph
```


